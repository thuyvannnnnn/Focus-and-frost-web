<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Báo cáo Pomodoro dạng lịch tháng</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  <header class="bg-white shadow p-4 flex items-center justify-between sticky top-0 z-20">
    <button id="prevMonthBtn" aria-label="Tháng trước" class="p-2 rounded hover:bg-gray-200 transition">
      <i class="fas fa-chevron-left text-gray-600"></i>
    </button>
    <h1 id="currentMonthYear" class="text-lg font-semibold text-gray-800 min-w-[160px] text-center"></h1>
    <button id="nextMonthBtn" aria-label="Tháng sau" class="p-2 rounded hover:bg-gray-200 transition">
      <i class="fas fa-chevron-right text-gray-600"></i>
    </button>
  </header>

  <main class="flex-grow p-4 max-w-4xl mx-auto w-full">
    <div id="calendar" class="grid grid-cols-7 gap-1 text-center select-none"></div>
  </main>

  <!-- Bottom Sheet -->
  <div id="bottomSheet" class="fixed inset-x-0 bottom-0 bg-white rounded-t-2xl shadow-xl max-h-[70vh] overflow-y-auto transform translate-y-full transition-transform duration-300 z-30" role="dialog" aria-modal="true" aria-labelledby="bottomSheetTitle">
    <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-0 bg-white z-10">
      <h2 id="bottomSheetTitle" class="text-lg font-semibold text-gray-800"></h2>
      <button id="closeBottomSheet" aria-label="Đóng" class="text-gray-600 hover:text-gray-900 transition">
        <i class="fas fa-times fa-lg"></i>
      </button>
    </div>
    <div class="p-4 space-y-3" id="bottomSheetContent"></div>
  </div>

  <script>
    /* =======================
       TIỆN ÍCH XỬ LÝ NGÀY/GIỜ
    ======================== */
    const pad = n => String(n).padStart(2, '0');

    // Tạo YYYY-MM-DD theo LOCAL TIME, tránh lệch múi giờ
    function ymdLocal(date) {
      return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}`;
    }

    function parseMaybeDate(v) {
      if (v == null) return null;
      if (v instanceof Date) return isNaN(v) ? null : v;
      if (typeof v === 'number') {
        const d = new Date(v);
        return isNaN(d) ? null : d;
      }
      if (typeof v === 'string') {
        // Nếu đúng pattern YYYY-MM-DD -> tạo Date local
        if (/^\d{4}-\d{2}-\d{2}$/.test(v)) {
          const [y,m,d] = v.split('-').map(Number);
          return new Date(y, m-1, d);
        }
        // Thử parse ISO/chuỗi ngày khác
        const d = new Date(v);
        return isNaN(d) ? null : d;
      }
      return null;
    }

    function hhmmFrom(value) {
      // value có thể là "HH:mm", ISO, timestamp, Date
      if (value == null) return '';
      if (typeof value === 'string' && /^\d{1,2}:\d{2}$/.test(value)) return value;
      const d = parseMaybeDate(value);
      if (!d) return '';
      return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function dateStrFromSession(session) {
      // Ưu tiên trường 'date'
      if ('date' in session && session.date != null) {
        const d = parseMaybeDate(session.date);
        if (d) return ymdLocal(d);
        // Nếu là string "YYYY-MM-DD" mà không parse được (hiếm), trả về thẳng
        if (typeof session.date === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(session.date)) return session.date;
      }
      // Lấy từ start/startAt/startTime có chứa ngày
      for (const k of ['start', 'startAt', 'startTime', 'from']) {
        const v = session[k];
        if (!v) continue;
        // Nếu là "HH:mm" thì chưa có ngày -> bỏ qua
        if (typeof v === 'string' && /^\d{1,2}:\d{2}$/.test(v)) continue;
        const d = parseMaybeDate(v);
        if (d) return ymdLocal(d);
      }
      // Thử lấy từ end
      for (const k of ['end', 'endAt', 'endTime', 'to']) {
        const v = session[k];
        if (!v) continue;
        if (typeof v === 'string' && /^\d{1,2}:\d{2}$/.test(v)) continue;
        const d = parseMaybeDate(v);
        if (d) return ymdLocal(d);
      }
      return null;
    }

    function durationInfo(session) {
      // Ưu tiên durationSeconds / durationMinutes
      let seconds = null;
      if (Number.isFinite(session.durationSeconds)) seconds = Math.max(0, session.durationSeconds);
      if (seconds == null && Number.isFinite(session.seconds)) seconds = Math.max(0, session.seconds);
      if (seconds == null && Number.isFinite(session.durationMinutes)) seconds = Math.max(0, session.durationMinutes * 60);
      if (seconds == null && Number.isFinite(session.minutes)) seconds = Math.max(0, session.minutes * 60);

      // Tự tính từ start/end nếu cần
      if (seconds == null) {
        const start = session.start ?? session.startAt ?? session.from ?? session.startTime;
        const end   = session.end   ?? session.endAt   ?? session.to   ?? session.endTime;

        // Nếu cả start & end là "HH:mm"
        if (typeof start === 'string' && /^\d{1,2}:\d{2}$/.test(start) &&
            typeof end   === 'string' && /^\d{1,2}:\d{2}$/.test(end)) {
          const [sh, sm] = start.split(':').map(Number);
          const [eh, em] = end.split(':').map(Number);
          let diff = (eh*60+em) - (sh*60+sm);
          if (diff < 0) diff += 24*60; // qua nửa đêm
          seconds = diff * 60;
        } else {
          // Thử parse Date đầy đủ
          const sd = parseMaybeDate(start);
          const ed = parseMaybeDate(end);
          if (sd && ed) {
            seconds = Math.max(0, Math.round((ed - sd)/1000));
          }
        }
      }

      if (seconds == null) seconds = 0;
      const minutes = Math.floor(seconds / 60);
      return { seconds, minutes };
    }

    function normalizeSession(session) {
      const dateStr = dateStrFromSession(session);
      const { seconds, minutes } = durationInfo(session);
      const startDisp = hhmmFrom(session.start ?? session.startAt ?? session.from ?? session.startTime);
      const endDisp   = hhmmFrom(session.end   ?? session.endAt   ?? session.to   ?? session.endTime);
      const pomos = Number.isFinite(session.pomodoros) ? session.pomodoros
                  : Number.isFinite(session.pomodoro)  ? session.pomodoro
                  : Number.isFinite(session.pomos)     ? session.pomos
                  : Number.isFinite(session.poms)      ? session.poms
                  : Math.round(minutes / 25); // ước lượng nếu không có
      const task = session.task ?? session.title ?? session.name ?? 'Không có mô tả';

      return {
        dateStr,
        durationMinutes: minutes,
        durationSeconds: seconds,
        pomodoros: pomos,
        startTime: startDisp || '--:--',
        endTime: endDisp || '--:--',
        task
      };
    }

    /* =======================
       ĐỌC & TỔNG HỢP DỮ LIỆU
    ======================== */
    function loadSessionHistoryRaw() {
      try {
        const raw = localStorage.getItem('sessionHistory');
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function loadSessionHistoryNormalized() {
      const raw = loadSessionHistoryRaw();
      return raw.map(normalizeSession).filter(s => !!s.dateStr);
    }

    function getDayDetail(dateStr) {
      const norm = loadSessionHistoryNormalized().filter(s => s.dateStr === dateStr);
      if (norm.length === 0) {
        return { date: dateStr, totalMinutes: 0, pomodoros: 0, sessions: [] };
      }
      const totalMinutes = norm.reduce((sum, s) => sum + s.durationMinutes, 0);
      const totalPomos = norm.reduce((sum, s) => sum + (Number.isFinite(s.pomodoros) ? s.pomodoros : 0), 0);
      return {
        date: dateStr,
        totalMinutes,
        pomodoros: totalPomos,
        sessions: norm.map(s => ({
          startTime: s.startTime,
          endTime: s.endTime,
          duration: s.durationMinutes,
          task: s.task
        }))
      };
    }

    /* =======================
       RENDER LỊCH & SHEET
    ======================== */
    function renderWeekDays() {
      const weekDays = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
      return weekDays.map(d =>
        `<div class="font-semibold text-gray-600 py-2 border-b border-gray-300 select-none">${d}</div>`
      ).join('');
    }

    function renderCalendar(year, month) {
      const calendarEl = document.getElementById('calendar');
      calendarEl.innerHTML = '';

      const monthNames = ['Tháng 1','Tháng 2','Tháng 3','Tháng 4','Tháng 5','Tháng 6','Tháng 7','Tháng 8','Tháng 9','Tháng 10','Tháng 11','Tháng 12'];
      document.getElementById('currentMonthYear').textContent = `${monthNames[month]} ${year}`;

      calendarEl.insertAdjacentHTML('beforeend', renderWeekDays());

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const firstDayWeekday = firstDay.getDay();

      // Dùng dữ liệu normalized một lần để tăng hiệu năng
      const normalized = loadSessionHistoryNormalized();

      for (let i = 0; i < firstDayWeekday; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'py-3';
        calendarEl.appendChild(emptyCell);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${pad(month + 1)}-${pad(day)}`;
        const daySessions = normalized.filter(s => s.dateStr === dateStr);
        const totalMinutes = daySessions.reduce((sum, s) => sum + s.durationMinutes, 0);

        const dayBtn = document.createElement('button');
        dayBtn.type = 'button';
        dayBtn.className =
          'relative w-full aspect-square flex flex-col items-center justify-center rounded-md text-gray-800 font-medium hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-red-500 transition p-2';

        dayBtn.setAttribute('aria-label', `Ngày ${day} ${month+1}/${year}`);

        const today = new Date();
        if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
          dayBtn.classList.add('bg-red-50');
        }

        dayBtn.innerHTML = `<span class="font-medium">${day}</span>`;

        if (totalMinutes > 0) {
          const infoDiv = document.createElement('div');
          infoDiv.className = 'mt-auto text-xs text-center';
          infoDiv.innerHTML = `
            <div class="text-green-600 font-medium">${totalMinutes} phút</div>
            <div class="text-gray-500">${daySessions.length} phiên</div>
          `;
          dayBtn.appendChild(infoDiv);
          dayBtn.classList.add('bg-green-50', 'border', 'border-green-200');
        }

        dayBtn.addEventListener('click', () => openBottomSheet(dateStr));
        calendarEl.appendChild(dayBtn);
      }
    }

    function openBottomSheet(dateStr) {
      const detail = getDayDetail(dateStr);
      const [y,m,d] = dateStr.split('-').map(Number);
      const dateObj = new Date(y, m-1, d);

      document.getElementById('bottomSheetTitle').textContent =
        `Ngày ${pad(dateObj.getDate())}/${pad(dateObj.getMonth()+1)}/${dateObj.getFullYear()}`;

      document.getElementById('bottomSheetContent').innerHTML = `
        <div class="space-y-4">
          <div class="flex justify-between items-center">
            <h3 class="font-bold">Tổng thời gian</h3>
            <span>${detail.totalMinutes} phút (${detail.pomodoros} pomodoro)</span>
          </div>
          ${
            detail.sessions.length > 0
              ? `<div class="border-t pt-3">
                  <h3 class="font-bold mb-2">Các phiên làm việc</h3>
                  <ul class="space-y-3">
                    ${detail.sessions.map(s => `
                      <li class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <div>
                          <span class="font-medium">${s.startTime} → ${s.endTime}</span>
                          <p class="text-sm text-gray-600">${s.task}</p>
                        </div>
                        <span class="text-gray-700">${s.duration} phút</span>
                      </li>
                    `).join('')}
                  </ul>
                </div>`
              : '<p class="text-gray-500 text-center py-4">Không có phiên làm việc nào</p>'
          }
        </div>
      `;

      const bs = document.getElementById('bottomSheet');
      bs.classList.remove('translate-y-full');
      bs.classList.add('translate-y-0');
      document.body.style.overflow = 'hidden';
    }

    function closeBottomSheet() {
      const bs = document.getElementById('bottomSheet');
      bs.classList.remove('translate-y-0');
      bs.classList.add('translate-y-full');
      document.body.style.overflow = '';
    }

    document.getElementById('closeBottomSheet').addEventListener('click', closeBottomSheet);
    window.addEventListener('click', (e) => {
      const bs = document.getElementById('bottomSheet');
      if (!bs.classList.contains('translate-y-full') && !bs.contains(e.target) && e.target.tagName !== 'BUTTON') {
        closeBottomSheet();
      }
    });

    /* =======================
       KHỞI TẠO & ĐIỀU HƯỚNG
    ======================== */
    let currentDate = new Date();
    let currentYear = currentDate.getFullYear();
    let currentMonth = currentDate.getMonth();

    document.getElementById('prevMonthBtn').addEventListener('click', () => {
      currentMonth--;
      if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      renderCalendar(currentYear, currentMonth);
    });

    document.getElementById('nextMonthBtn').addEventListener('click', () => {
      currentMonth++;
      if (currentMonth > 11) { currentMonth = 0; currentYear++; }
      renderCalendar(currentYear, currentMonth);
    });

    // Render lần đầu
    renderCalendar(currentYear, currentMonth);
  </script>
</body>
</html>
