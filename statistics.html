<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Báo cáo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background: transparent;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: rgba(0,0,0,0.2);
      border-radius: 3px;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-4">
  <div class="w-full max-w-4xl">
    <header class="mb-6 flex items-center justify-between">
      <button
        id="prevMonthBtn"
        aria-label="Tháng trước"
        class="p-2 rounded hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-red-500"
      >
        <i class="fas fa-chevron-left text-gray-700"></i>
      </button>
      <h1 id="headerTitle" class="text-3xl font-semibold text-gray-800 text-center flex-1">Báo cáo</h1>
      <button
        id="nextMonthBtn"
        aria-label="Tháng sau"
        class="p-2 rounded hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-red-500"
      >
        <i class="fas fa-chevron-right text-gray-700"></i>
      </button>
    </header>

    <div id="calendar" class="grid grid-cols-7 gap-2 text-center text-sm select-none"></div>
  </div>

  <div
    id="bottomSheet"
    class="fixed inset-x-0 bottom-0 max-h-[80vh] bg-white rounded-t-2xl shadow-xl transform translate-y-full transition-transform duration-300 ease-in-out flex flex-col"
    style="max-width: 480px; margin: 0 auto; left: 0; right: 0;"
    aria-modal="true"
    role="dialog"
    aria-labelledby="bottomSheetTitle"
  >
    <div class="flex justify-between items-center p-4 border-b border-gray-200">
      <h2 id="bottomSheetTitle" class="text-lg font-semibold text-gray-900"></h2>
      <button
        id="closeBtn"
        aria-label="Đóng"
        class="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-red-500 rounded"
      >
        <i class="fas fa-times fa-lg"></i>
      </button>
    </div>
    <div class="p-4 overflow-y-auto scrollbar-thin flex-1">
      <p id="totalTimePomodoro" class="text-gray-700 mb-4"></p>
      <ul id="sessionsList" class="space-y-3 text-gray-700"></ul>
      <p id="noSessions" class="text-gray-500 italic text-center mt-6 hidden">Chưa có phiên tập trung</p>
    </div>
  </div>

  <script>
    const inputData = [
      { date: "2024-06-01", totalMinutes: 0 },
      { date: "2024-06-02", totalMinutes: 50 },
      { date: "2024-06-03", totalMinutes: 0 },
      { date: "2024-06-04", totalMinutes: 75 },
      { date: "2024-06-05", totalMinutes: 0 },
      { date: "2024-06-06", totalMinutes: 25 },
      { date: "2024-06-07", totalMinutes: 0 },
      { date: "2024-06-08", totalMinutes: 0 },
      { date: "2024-06-09", totalMinutes: 100 },
      { date: "2024-06-10", totalMinutes: 0 },
      { date: "2024-06-11", totalMinutes: 0 },
      { date: "2024-06-12", totalMinutes: 0 },
      { date: "2024-06-13", totalMinutes: 0 },
      { date: "2024-06-14", totalMinutes: 0 },
      { date: "2024-06-15", totalMinutes: 125 },
      { date: "2024-06-16", totalMinutes: 0 },
      { date: "2024-06-17", totalMinutes: 0 },
      { date: "2024-06-18", totalMinutes: 0 },
      { date: "2024-06-19", totalMinutes: 0 },
      { date: "2024-06-20", totalMinutes: 0 },
      { date: "2024-06-21", totalMinutes: 0 },
      { date: "2024-06-22", totalMinutes: 0 },
      { date: "2024-06-23", totalMinutes: 0 },
      { date: "2024-06-24", totalMinutes: 0 },
      { date: "2024-06-25", totalMinutes: 0 },
      { date: "2024-06-26", totalMinutes: 0 },
      { date: "2024-06-27", totalMinutes: 0 },
      { date: "2024-06-28", totalMinutes: 0 },
      { date: "2024-06-29", totalMinutes: 0 },
      { date: "2024-06-30", totalMinutes: 0 },
      // Add some data for May 2024 for testing previous month
      { date: "2024-05-01", totalMinutes: 30 },
      { date: "2024-05-15", totalMinutes: 60 },
      { date: "2024-05-20", totalMinutes: 0 },
      { date: "2024-05-31", totalMinutes: 45 },
      // Add some data for July 2024 for testing next month
      { date: "2024-07-01", totalMinutes: 0 },
      { date: "2024-07-10", totalMinutes: 80 },
      { date: "2024-07-15", totalMinutes: 0 },
      { date: "2024-07-20", totalMinutes: 100 },
      { date: "2024-07-31", totalMinutes: 0 },
    ];

    function getDayDetail(date) {
      const dayData = inputData.find((d) => d.date === date);
      if (!dayData || dayData.totalMinutes === 0) {
        return Promise.resolve({
          date,
          totalMinutes: 0,
          pomodoros: 0,
          sessions: [],
        });
      }
      const pomodoros = Math.floor(dayData.totalMinutes / 25);
      const sessions = [];
      let startHour = 9;
      let startMinute = 0;
      for (let i = 0; i < pomodoros; i++) {
        const startAt = `${String(startHour).padStart(2, "0")}:${String(startMinute).padStart(2, "0")}`;
        startMinute += 25;
        if (startMinute >= 60) {
          startHour++;
          startMinute -= 60;
        }
        let endHour = startHour;
        let endMinute = startMinute;
        if (i < pomodoros - 1) {
          endMinute += 5;
          if (endMinute >= 60) {
            endHour++;
            endMinute -= 60;
          }
        }
        const endAt = `${String(endHour).padStart(2, "0")}:${String(endMinute).padStart(2, "0")}`;
        sessions.push({
          startAt,
          endAt,
          label: `Pomodoro ${i + 1}`,
        });
        startHour = endHour;
        startMinute = endMinute;
      }
      return Promise.resolve({
        date,
        totalMinutes: dayData.totalMinutes,
        pomodoros,
        sessions,
      });
    }

    function formatDateVN(dateStr) {
      const d = new Date(dateStr + "T00:00:00");
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yyyy = d.getFullYear();
      return `${dd}/${mm}/${yyyy}`;
    }

    // Format month/year for header: "Tháng MM/yyyy"
    function formatMonthYear(year, month) {
      return `Tháng ${String(month + 1).padStart(2, "0")}/${year}`;
    }

    // State for current displayed month/year
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();

    function buildCalendarDays(year, month) {
      const firstDayOfMonth = new Date(year, month, 1);
      const lastDayOfMonth = new Date(year, month + 1, 0);
      const daysInMonth = lastDayOfMonth.getDate();

      const startWeekDay = firstDayOfMonth.getDay();
      const offset = startWeekDay === 0 ? 6 : startWeekDay - 1;

      const prevMonthLastDay = new Date(year, month, 0).getDate();

      const days = [];

      for (let i = offset - 1; i >= 0; i--) {
        const dayNum = prevMonthLastDay - i;
        const dateObj = new Date(year, month - 1, dayNum);
        days.push({
          dateObj,
          inCurrentMonth: false,
          dateStr: dateObj.toISOString().slice(0, 10),
        });
      }

      for (let d = 1; d <= daysInMonth; d++) {
        const dateObj = new Date(year, month, d);
        days.push({
          dateObj,
          inCurrentMonth: true,
          dateStr: dateObj.toISOString().slice(0, 10),
        });
      }

      while (days.length % 7 !== 0) {
        const nextDayNum = days.length - (offset + daysInMonth) + 1;
        const dateObj = new Date(year, month + 1, nextDayNum);
        days.push({
          dateObj,
          inCurrentMonth: false,
          dateStr: dateObj.toISOString().slice(0, 10),
        });
      }

      return days;
    }

    const dataMap = {};
    inputData.forEach((item) => {
      dataMap[item.date] = item.totalMinutes;
    });

    function renderCalendar() {
      const calendarEl = document.getElementById("calendar");
      calendarEl.innerHTML = "";

      // Update header title
      const headerTitle = document.getElementById("headerTitle");
      headerTitle.textContent = formatMonthYear(currentYear, currentMonth);

      const weekdays = ["T2", "T3", "T4", "T5", "T6", "T7", "CN"];
      weekdays.forEach((wd) => {
        const th = document.createElement("div");
        th.className = "font-semibold text-gray-600 py-1";
        th.textContent = wd;
        calendarEl.appendChild(th);
      });

      const days = buildCalendarDays(currentYear, currentMonth);

      days.forEach(({ dateObj, inCurrentMonth, dateStr }) => {
        const dayNum = dateObj.getDate();
        const totalMinutes = dataMap[dateStr] ?? 0;

        const dayCell = document.createElement("button");
        dayCell.type = "button";
        dayCell.className =
          "relative w-full aspect-square rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 flex items-center justify-center text-sm font-medium " +
          (inCurrentMonth ? "text-gray-900" : "text-gray-400") +
          " hover:bg-gray-100";

        if (inCurrentMonth && totalMinutes > 0) {
          dayCell.classList.add("border-2", "border-red-500");
        }

        dayCell.textContent = dayNum;
        dayCell.setAttribute("aria-label", `Ngày ${formatDateVN(dateStr)}`);

        if (inCurrentMonth) {
          dayCell.addEventListener("click", () => {
            openBottomSheet(dateStr);
          });
        } else {
          dayCell.disabled = true;
        }

        calendarEl.appendChild(dayCell);
      });
    }

    const bottomSheet = document.getElementById("bottomSheet");
    const bottomSheetTitle = document.getElementById("bottomSheetTitle");
    const totalTimePomodoro = document.getElementById("totalTimePomodoro");
    const sessionsList = document.getElementById("sessionsList");
    const noSessions = document.getElementById("noSessions");
    const closeBtn = document.getElementById("closeBtn");

    async function openBottomSheet(dateStr) {
      bottomSheetTitle.textContent = `Ngày ${formatDateVN(dateStr)}`;
      totalTimePomodoro.textContent = "Đang tải...";
      sessionsList.innerHTML = "";
      noSessions.classList.add("hidden");

      bottomSheet.classList.remove("translate-y-full");
      bottomSheet.classList.add("translate-y-0");
      document.body.style.overflow = "hidden";

      try {
        const detail = await getDayDetail(dateStr);
        if (detail.totalMinutes === 0) {
          totalTimePomodoro.textContent = "";
          noSessions.classList.remove("hidden");
          sessionsList.innerHTML = "";
        } else {
          noSessions.classList.add("hidden");
          totalTimePomodoro.textContent = `Tổng thời gian: ${detail.totalMinutes} phút · ${detail.pomodoros} Pomodoro`;
          sessionsList.innerHTML = "";
          detail.sessions.forEach((session) => {
            const li = document.createElement("li");
            li.textContent = `${session.startAt}–${session.endAt} · ${session.label}`;
            sessionsList.appendChild(li);
          });
        }
      } catch (e) {
        totalTimePomodoro.textContent = "";
        noSessions.classList.remove("hidden");
        sessionsList.innerHTML = "";
      }
    }

    function closeBottomSheet() {
      bottomSheet.classList.remove("translate-y-0");
      bottomSheet.classList.add("translate-y-full");
      document.body.style.overflow = "";
    }

    closeBtn.addEventListener("click", closeBottomSheet);

    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !bottomSheet.classList.contains("translate-y-full")) {
        closeBottomSheet();
      }
    });

    // Buttons for month navigation
    const prevMonthBtn = document.getElementById("prevMonthBtn");
    const nextMonthBtn = document.getElementById("nextMonthBtn");

    prevMonthBtn.addEventListener("click", () => {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      renderCalendar();
      closeBottomSheet();
    });

    nextMonthBtn.addEventListener("click", () => {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderCalendar();
      closeBottomSheet();
    });
// Mảng lưu tất cả lịch sử tập trung
let sessionHistory = [];

// Hàm bắt đầu tập trung
function startFocus() {
  return {
    startAt: new Date() // Lưu thời gian bắt đầu
  };
}

// Hàm kết thúc tập trung và lưu vào sessionHistory
function endFocus(session) {
  session.endAt = new Date(); // Lưu thời gian kết thúc

  // Tính số phút tập trung
  const diffMs = session.endAt - session.startAt;
  session.durationMinutes = Math.floor(diffMs / (1000 * 60));

  // Lưu vào sessionHistory
  sessionHistory.push(session);
}

// ----- Ví dụ sử dụng -----

// Bắt đầu tập trung
let currentSession = startFocus();

// Giả sử sau 45 phút...
setTimeout(() => {
  // Kết thúc và lưu
  endFocus(currentSession);

  console.log("Session history:", sessionHistory);
}, 45 * 60 * 1000); // 45 phút
  </script>
</body>
</html>
