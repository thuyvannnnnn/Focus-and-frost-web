<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Báo cáo Pomodoro dạng lịch tháng</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    /* Bottom sheet animation */
    .bottom-sheet-enter {
      transform: translateY(100%);
    }
    .bottom-sheet-enter-active {
      transform: translateY(0);
      transition: transform 300ms ease-in-out;
    }
    .bottom-sheet-leave {
      transform: translateY(0);
    }
    .bottom-sheet-leave-active {
      transform: translateY(100%);
      transition: transform 300ms ease-in-out;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  <header class="bg-white shadow p-4 flex items-center justify-between sticky top-0 z-20">
    <h1 class="text-xl font-semibold text-gray-800">Báo cáo Pomodoro</h1>
    <button id="prevMonthBtn" aria-label="Tháng trước" class="p-2 rounded hover:bg-gray-200 transition">
      <i class="fas fa-chevron-left text-gray-600"></i>
    </button>
    <div id="currentMonthYear" class="text-lg font-medium text-gray-700 min-w-[140px] text-center"></div>
    <button id="nextMonthBtn" aria-label="Tháng sau" class="p-2 rounded hover:bg-gray-200 transition">
      <i class="fas fa-chevron-right text-gray-600"></i>
    </button>
  </header>

  <main class="flex-grow p-4 max-w-4xl mx-auto w-full">
    <div id="calendar" class="grid grid-cols-7 gap-1 text-center select-none"></div>
  </main>

  <!-- Bottom Sheet -->
  <div
    id="bottomSheet"
    class="fixed inset-x-0 bottom-0 bg-white rounded-t-2xl shadow-xl max-h-[70vh] overflow-y-auto transform translate-y-full transition-transform duration-300 z-30"
    role="dialog"
    aria-modal="true"
    aria-labelledby="bottomSheetTitle"
  >
    <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-0 bg-white z-10">
      <h2 id="bottomSheetTitle" class="text-lg font-semibold text-gray-800"></h2>
      <button id="closeBottomSheet" aria-label="Đóng" class="text-gray-600 hover:text-gray-900 transition">
        <i class="fas fa-times fa-lg"></i>
      </button>
    </div>
    <div class="p-4 space-y-3" id="bottomSheetContent">
      <!-- Content injected by JS -->
    </div>
  </div>

  <script>
    // Utility functions
    function pad(num) {
      return num.toString().padStart(2, '0');
    }

    function formatDate(date) {
      // date: Date object
      return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}`;
    }

    function formatDateDisplay(date) {
      // date: Date object
      return `${pad(date.getDate())}/${pad(date.getMonth() + 1)}/${date.getFullYear()}`;
    }

    function parseDateString(dateStr) {
      // dateStr: "YYYY-MM-DD"
      const parts = dateStr.split('-');
      return new Date(parts[0], parts[1] - 1, parts[2]);
    }

    // Load sessionHistory from localStorage or fallback to empty array
    function loadSessionHistory() {
      try {
        const data = localStorage.getItem('sessionHistory');
        if (!data) return [];
        return JSON.parse(data);
      } catch {
        return [];
      }
    }

    // Get day detail from sessionHistory by date string YYYY-MM-DD
    function getDayDetail(date) {
      // date: YYYY-MM-DD string
      const sessionHistory = loadSessionHistory();
      const dayData = sessionHistory.find((d) => d.date === date);
      if (dayData) {
        // Calculate pomodoros = totalMinutes / 25 rounded down
        return {
          date: dayData.date,
          totalMinutes: 0,
          pomodoros: 0,
          sessions: [],
        };
      }
      // If no data, return default
      return {
        date,
        totalMinutes: 0,
        pomodoros: 0,
        sessions: [],
      };
    }

    // Render calendar header (days of week)
    function renderWeekDays() {
      const weekDays = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
      return weekDays
        .map(
          (d) =>
            `<div class="font-semibold text-gray-600 py-2 border-b border-gray-300 select-none">${d}</div>`
        )
        .join('');
    }

    // Render calendar days for a given month and year
    function renderCalendar(year, month) {
      // month: 0-based (0=Jan)
      const calendarEl = document.getElementById('calendar');
      calendarEl.innerHTML = '';

      // Show month-year text
      const currentMonthYearEl = document.getElementById('currentMonthYear');
      const monthNames = [
        'Tháng 1',
        'Tháng 2',
        'Tháng 3',
        'Tháng 4',
        'Tháng 5',
        'Tháng 6',
        'Tháng 7',
        'Tháng 8',
        'Tháng 9',
        'Tháng 10',
        'Tháng 11',
        'Tháng 12',
      ];
      currentMonthYearEl.textContent = `${monthNames[month]} ${year}`;

      // Render weekdays header
      calendarEl.insertAdjacentHTML('beforeend', renderWeekDays());

      // First day of month
      const firstDay = new Date(year, month, 1);
      // Last day of month
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();

      // Day of week of first day (0=Sun, 6=Sat)
      const firstDayWeekday = firstDay.getDay();

      // Load sessionHistory
      const sessionHistory = loadSessionHistory();

      // Create empty cells for days before first day
      for (let i = 0; i < firstDayWeekday; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'py-3';
        calendarEl.appendChild(emptyCell);
      }

      // Create day cells
      for (let day = 1; day <= daysInMonth; day++) {
        const dateObj = new Date(year, month, day);
        const dateStr = formatDate(dateObj);

        // Find session data for this date
        const dayData = sessionHistory.find((d) => d.date === dateStr);

        // Determine if circle red border needed
        // But we remove all totalMinutes > 0, so no red circle
        const hasFocus = false;

        // Create day button
        const dayBtn = document.createElement('button');
        dayBtn.type = 'button';
        dayBtn.className =
          'relative w-full aspect-square flex items-center justify-center rounded-md text-gray-800 font-medium hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-red-500 transition';

        dayBtn.setAttribute('aria-label', `Ngày ${day} ${monthNames[month]} ${year}`);

        // If day is today, highlight background lightly
        const today = new Date();
        if (
          day === today.getDate() &&
          month === today.getMonth() &&
          year === today.getFullYear()
        ) {
          dayBtn.classList.add('bg-red-50');
        }

        // No red circle border because totalMinutes always 0

        dayBtn.textContent = day;

        // Click event to open bottom sheet
        dayBtn.addEventListener('click', () => {
          openBottomSheet(dateStr, year, month, day);
        });

        calendarEl.appendChild(dayBtn);
      }
    }

    // Open bottom sheet with day detail
    function openBottomSheet(dateStr, year, month, day) {
      const bottomSheet = document.getElementById('bottomSheet');
      const bottomSheetTitle = document.getElementById('bottomSheetTitle');
      const bottomSheetContent = document.getElementById('bottomSheetContent');

      const detail = getDayDetail(dateStr);

      // Title: Ngày dd/MM/yyyy
      const dateObj = parseDateString(dateStr);
      bottomSheetTitle.textContent = `Ngày ${formatDateDisplay(dateObj)}`;

      // Content:
      // Dòng 2: Tổng thời gian: {totalMinutes} phút · {pomodoros} Pomodoro
      // Danh sách sessions: {startAt}–{endAt} · {label}
      bottomSheetContent.innerHTML = '';

      if (detail.totalMinutes === 0) {
        const noDataEl = document.createElement('p');
        noDataEl.className = 'text-gray-500 text-center py-6';
        noDataEl.textContent = 'Chưa có phiên tập trung';
        bottomSheetContent.appendChild(noDataEl);
      } else {
        // This branch will never run because totalMinutes always 0
        const summaryEl = document.createElement('p');
        summaryEl.className = 'text-gray-700 font-medium mb-3';
        summaryEl.textContent = `Tổng thời gian: ${detail.totalMinutes} phút · ${detail.pomodoros} Pomodoro`;
        bottomSheetContent.appendChild(summaryEl);

        // Sessions list
        const sessionsList = document.createElement('ul');
        sessionsList.className = 'space-y-2';

        detail.sessions.forEach((session) => {
          const li = document.createElement('li');
          li.className = 'text-gray-700 text-sm';

          // Format: {startAt}–{endAt} · {label}
          li.textContent = `${session.startAt}–${session.endAt} · ${session.label}`;
          sessionsList.appendChild(li);
        });

        bottomSheetContent.appendChild(sessionsList);
      }

      // Show bottom sheet
      bottomSheet.classList.remove('translate-y-full');
      bottomSheet.classList.add('translate-y-0');
      // Prevent body scroll
      document.body.style.overflow = 'hidden';
    }

    // Close bottom sheet
    function closeBottomSheet() {
      const bottomSheet = document.getElementById('bottomSheet');
      bottomSheet.classList.remove('translate-y-0');
      bottomSheet.classList.add('translate-y-full');
      document.body.style.overflow = '';
    }

    // Initialize calendar with current month
    let currentDate = new Date();
    let currentYear = currentDate.getFullYear();
    let currentMonth = currentDate.getMonth();

    // Navigation buttons
    document.getElementById('prevMonthBtn').addEventListener('click', () => {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      renderCalendar(currentYear, currentMonth);
    });

    document.getElementById('nextMonthBtn').addEventListener('click', () => {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderCalendar(currentYear, currentMonth);
    });

    // Close bottom sheet button
    document.getElementById('closeBottomSheet').addEventListener('click', closeBottomSheet);

    // Close bottom sheet on outside click (optional)
    window.addEventListener('click', (e) => {
      const bottomSheet = document.getElementById('bottomSheet');
      if (
        !bottomSheet.classList.contains('translate-y-full') &&
        !bottomSheet.contains(e.target) &&
        e.target.tagName !== 'BUTTON'
      ) {
        closeBottomSheet();
      }
    });

    // Initial render
    renderCalendar(currentYear, currentMonth);

    // For demo/testing: if no sessionHistory in localStorage, add sample data with zero totalMinutes and empty sessions
    if (!localStorage.getItem('sessionHistory')) {
      const sampleData = [
        {
          date: formatDate(new Date()),
          totalMinutes: 0,
          sessions: [],
        },
        {
          date: formatDate(new Date(new Date().setDate(new Date().getDate() - 2))),
          totalMinutes: 0,
          sessions: [],
        },
        {
          date: formatDate(new Date(new Date().setDate(1))),
          totalMinutes: 0,
          sessions: [],
        },
        {
          date: formatDate(new Date(new Date().setDate(3))),
          totalMinutes: 0,
          sessions: [],
        },
        {
          date: formatDate(new Date(new Date().setDate(15))),
          totalMinutes: 0,
          sessions: [],
        },
      ];
      localStorage.setItem('sessionHistory', JSON.stringify(sampleData));
      renderCalendar(currentYear, currentMonth);
    }
  </script>
</body>
</html>
