<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <title>Thống kê</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    rel="stylesheet"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: "Roboto", sans-serif;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col bg-gray-50 relative">
  <img
    alt="Background image of abstract design"
    class="fixed inset-0 w-full h-full object-cover -z-10"
    height="1080"
    src="https://i.ibb.co/JRr5YSFS/66-F84-D93-7422-4-D12-AD64-8-B3103-E20-BD3.png"
    width="1920"
  />
  <header
    class="bg-white bg-opacity-80 backdrop-blur-md shadow-md sticky top-0 z-20"
  >
    <div
      class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between"
    >
      <h1 class="text-3xl font-semibold text-green-700">Thống kê</h1>
      <div class="flex items-center space-x-3">
        <i class="fas fa-user-circle text-green-700 text-2xl"></i>
        <span class="text-green-700 font-medium" id="username"></span>
      </div>
    </div>
  </header>
  <main class="flex-grow max-w-7xl mx-auto px-4 py-12 w-full">
    <section
      class="bg-white bg-opacity-90 rounded-lg shadow p-6 overflow-x-auto"
    >
      <svg
        aria-label="Biểu đồ thời gian tập trung theo ngày"
        class="w-full max-w-full h-72 sm:h-96"
        id="focusChart"
        role="img"
        viewBox="0 0 800 400"
        xmlns="http://www.w3.org/2000/svg"
      ></svg>
    </section>
  </main>
  <script>
    // Lấy thông tin người dùng từ localStorage
    const user = JSON.parse(localStorage.getItem("user")) || {
      name: "Người dùng",
    };
    document.getElementById("username").textContent = user.name;

    // Giả lập sessionHistory nếu chưa có (mỗi phần tử có: date (ISO string), focusMinutes (number))
    // Ví dụ dữ liệu 15 ngày gần đây
    let sessionHistory = JSON.parse(localStorage.getItem("sessionHistory"));
    if (!sessionHistory) {
      const today = new Date();
      sessionHistory = [];
      for (let i = 14; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(today.getDate() - i);
        sessionHistory.push({
          date: d.toISOString().slice(0, 10),
          focusMinutes: Math.floor(Math.random() * 120), // 0-120 phút
        });
      }
      localStorage.setItem("sessionHistory", JSON.stringify(sessionHistory));
    }

    // Chuẩn bị dữ liệu cho biểu đồ
    // Lấy ngày theo thứ tự tăng dần
    sessionHistory.sort((a, b) => new Date(a.date) - new Date(b.date));

    const svg = document.getElementById("focusChart");
    const width = 800;
    const height = 400;
    const margin = { top: 40, right: 40, bottom: 60, left: 60 };

    // Tính max phút tập trung để scale trục y
    const maxFocus = Math.max(...sessionHistory.map((d) => d.focusMinutes));
    const maxY = Math.ceil(maxFocus / 10) * 10 || 60; // làm tròn lên 10 phút, tối thiểu 60

    // Hàm chuyển đổi giá trị focusMinutes sang tọa độ y trong SVG
    function yScale(value) {
      // y=margin.top là max, y=height-margin.bottom là min
      return (
        margin.top +
        ((maxY - value) / maxY) * (height - margin.top - margin.bottom)
      );
    }

    // Hàm chuyển đổi ngày sang tọa độ x trong SVG
    function xScale(index) {
      const n = sessionHistory.length;
      return margin.left + (index / (n - 1)) * (width - margin.left - margin.right);
    }

    // Xóa nội dung SVG trước khi vẽ
    while (svg.firstChild) {
      svg.removeChild(svg.firstChild);
    }

    // Vẽ trục Y (thời gian tập trung)
    const yAxisGroup = document.createElementNS(
      "http://www.w3.org/2000/svg",
      "g"
    );
    svg.appendChild(yAxisGroup);

    // Vẽ các vạch và nhãn trục Y
    const yTicks = 6;
    for (let i = 0; i <= yTicks; i++) {
      const val = (maxY / yTicks) * i;
      const y = yScale(val);
      // Vạch ngang
      const line = document.createElementNS(
        "http://www.w3.org/2000/svg",
        "line"
      );
      line.setAttribute("x1", margin.left);
      line.setAttribute("x2", width - margin.right);
      line.setAttribute("y1", y);
      line.setAttribute("y2", y);
      line.setAttribute("stroke", "#A7F3D0"); // Tailwind green-200
      line.setAttribute("stroke-dasharray", "4 2");
      yAxisGroup.appendChild(line);

      // Nhãn
      const text = document.createElementNS(
        "http://www.w3.org/2000/svg",
        "text"
      );
      text.setAttribute("x", margin.left - 10);
      text.setAttribute("y", y + 6);
      text.setAttribute("text-anchor", "end");
      text.setAttribute("font-size", "14");
      text.setAttribute("fill", "#166534"); // Tailwind green-800
      text.textContent = val.toFixed(0);
      yAxisGroup.appendChild(text);
    }

    // Nhãn trục Y
    const yLabel = document.createElementNS(
      "http://www.w3.org/2000/svg",
      "text"
    );
    yLabel.setAttribute("x", margin.left - 50);
    yLabel.setAttribute("y", margin.top - 15);
    yLabel.setAttribute("font-size", "18");
    yLabel.setAttribute("fill", "#14532D"); // Tailwind green-900
    yLabel.setAttribute("font-weight", "bold");
    yLabel.textContent = "Thời gian (phút)";
    svg.appendChild(yLabel);

    // Vẽ trục X (ngày/tháng/năm)
    const xAxisGroup = document.createElementNS(
      "http://www.w3.org/2000/svg",
      "g"
    );
    svg.appendChild(xAxisGroup);

    // Vẽ trục X line
    const xAxisLine = document.createElementNS(
      "http://www.w3.org/2000/svg",
      "line"
    );
    xAxisLine.setAttribute("x1", margin.left);
    xAxisLine.setAttribute("x2", width - margin.right);
    xAxisLine.setAttribute("y1", height - margin.bottom);
    xAxisLine.setAttribute("y2", height - margin.bottom);
    xAxisLine.setAttribute("stroke", "#166534"); // Tailwind green-800
    xAxisLine.setAttribute("stroke-width", "2");
    xAxisGroup.appendChild(xAxisLine);

    // Vẽ nhãn ngày
    sessionHistory.forEach((d, i) => {
      const x = xScale(i);
      const y = height - margin.bottom;

      // Vạch nhỏ
      const tick = document.createElementNS(
        "http://www.w3.org/2000/svg",
        "line"
      );
      tick.setAttribute("x1", x);
      tick.setAttribute("x2", x);
      tick.setAttribute("y1", y);
      tick.setAttribute("y2", y + 6);
      tick.setAttribute("stroke", "#166534");
      tick.setAttribute("stroke-width", "1");
      xAxisGroup.appendChild(tick);

      // Nhãn ngày
      const text = document.createElementNS(
        "http://www.w3.org/2000/svg",
        "text"
      );
      text.setAttribute("x", x);
      text.setAttribute("y", y + 22);
      text.setAttribute("font-size", "12");
      text.setAttribute("fill", "#14532D");
      text.setAttribute("text-anchor", "middle");
      // Format ngày dd/mm/yyyy
      const dateObj = new Date(d.date);
      const day = dateObj.getDate().toString().padStart(2, "0");
      const month = (dateObj.getMonth() + 1).toString().padStart(2, "0");
      const year = dateObj.getFullYear();
      text.textContent = `${day}/${month}/${year}`;
      xAxisGroup.appendChild(text);
    });

    // Nhãn trục X
    const xLabel = document.createElementNS(
      "http://www.w3.org/2000/svg",
      "text"
    );
    xLabel.setAttribute("x", width / 2);
    xLabel.setAttribute("y", height - 8);
    xLabel.setAttribute("font-size", "18");
    xLabel.setAttribute("fill", "#14532D");
    xLabel.setAttribute("font-weight", "bold");
    xLabel.setAttribute("text-anchor", "middle");
    xLabel.textContent = "Mốc thời gian (ngày/tháng/năm)";
    svg.appendChild(xLabel);

    // Vẽ đường biểu đồ
    const linePath = document.createElementNS(
      "http://www.w3.org/2000/svg",
      "path"
    );
    let dPath = "";
    sessionHistory.forEach((d, i) => {
      const x = xScale(i);
      const y = yScale(d.focusMinutes);
      dPath += i === 0 ? `M${x},${y}` : ` L${x},${y}`;
    });
    linePath.setAttribute("d", dPath);
    linePath.setAttribute("fill", "none");
    linePath.setAttribute("stroke", "#22C55E"); // Tailwind green-500
    linePath.setAttribute("stroke-width", "3");
    svg.appendChild(linePath);

    // Vẽ các điểm trên đường
    sessionHistory.forEach((d, i) => {
      const x = xScale(i);
      const y = yScale(d.focusMinutes);
      const circle = document.createElementNS(
        "http://www.w3.org/2000/svg",
        "circle"
      );
      circle.setAttribute("cx", x);
      circle.setAttribute("cy", y);
      circle.setAttribute("r", 6);
      circle.setAttribute("fill", "#4ADE80"); // Tailwind green-400
      circle.setAttribute("stroke", "#166534"); // Tailwind green-800
      circle.setAttribute("stroke-width", "1.5");
      circle.style.cursor = "pointer";

      // Tooltip on hover
      circle.addEventListener("mouseenter", (e) => {
        const tooltip = document.createElement("div");
        tooltip.id = "tooltip";
        tooltip.style.position = "fixed";
        tooltip.style.background = "rgba(34, 197, 94, 0.9)";
        tooltip.style.color = "white";
        tooltip.style.padding = "6px 10px";
        tooltip.style.borderRadius = "6px";
        tooltip.style.fontSize = "14px";
        tooltip.style.pointerEvents = "none";
        tooltip.style.zIndex = 50;
        tooltip.textContent = `${d.focusMinutes} thời gian (phút) vào ngày ${d.date
          .split("-")
          .reverse()
          .join("/")}`;
        document.body.appendChild(tooltip);

        function moveTooltip(event) {
          const offsetX = 15;
          const offsetY = 15;
          let left = event.clientX + offsetX;
          let top = event.clientY + offsetY;
          const tooltipRect = tooltip.getBoundingClientRect();
          if (left + tooltipRect.width > window.innerWidth) {
            left = event.clientX - tooltipRect.width - offsetX;
          }
          if (top + tooltipRect.height > window.innerHeight) {
            top = event.clientY - tooltipRect.height - offsetY;
          }
          tooltip.style.left = left + "px";
          tooltip.style.top = top + "px";
        }

        moveTooltip(e);

        circle.addEventListener("mousemove", moveTooltip);

        circle.addEventListener("mouseleave", () => {
          circle.removeEventListener("mousemove", moveTooltip);
          if (tooltip.parentNode) tooltip.parentNode.removeChild(tooltip);
        });
      });

      svg.appendChild(circle);
    });
  </script>
</body>
</html>

