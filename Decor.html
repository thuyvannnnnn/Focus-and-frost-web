<html lang="vi" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trang tr√≠ b√°nh</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <style>
    /* Hide scrollbar for vertical scroll container */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    /* Transition for cake area shifting */
    #cake-area {
      transition: margin-right 0.3s ease;
    }
    /* When right panel is open, add margin-right to cake area */
    #cake-area.shifted {
      margin-right: 15vw;
      min-width: 0;
    }
    @media (max-width: 768px) {
      #cake-area.shifted {
        margin-right: 132px;
      }
    }
  </style>
</head>
<body class="h-full relative overflow-hidden font-sans bg-gray-50">
  <div id="app" class="h-full w-full relative flex flex-col items-center justify-center select-none">
    <!-- Background image full screen, cover height and width, object-cover -->
    <img
      src="https://i.ibb.co/7tNyB61M/IMG-4634.png"
      alt="Background image of a soft pastel colored abstract watercolor texture with pink, beige and light blue hues, suitable for a cake decoration app background"
      class="fixed top-0 left-0 w-full h-full object-cover -z-10"
      draggable="false"
    />

    <!-- Top left circular button: back to main page -->
    <button
      id="btn-back-main"
      aria-label="Quay v·ªÅ trang ch√≠nh"
      class="absolute top-4 left-4 w-12 h-12 rounded-full bg-white bg-opacity-70 backdrop-blur-sm flex items-center justify-center shadow-md hover:bg-opacity-90 transition"
      type="button"
    >
      <i class="fas fa-home text-gray-700 text-xl"></i>
    </button>

    <!-- Bottom left small circular button with clock icon: open history -->
    <button
      id="btn-history"
      aria-label="M·ªü l·ªãch s·ª≠ b√°nh ƒë√£ trang tr√≠"
      class="absolute bottom-4 left-4 w-10 h-10 rounded-full bg-white bg-opacity-70 backdrop-blur-sm flex items-center justify-center shadow-md hover:bg-opacity-90 transition text-lg"
      type="button"
    >
      üïì
    </button>

    <!-- Bottom right green "B·∫Øt ƒë·∫ßu" button -->
    <button
      id="btn-start"
      aria-label="B·∫Øt ƒë·∫ßu ch·ªçn b√°nh"
      class="absolute bottom-4 right-4 bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-semibold rounded-full px-6 py-3 shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
      type="button"
    >
      B·∫Øt ƒë·∫ßu
    </button>

    <!-- Main cake decoration area -->
    <div
      id="cake-area"
      class="relative w-full max-w-md aspect-square mx-auto mt-[26%] mb-24 flex items-center justify-center"
      style="min-height: 320px;"
      aria-label="Khu v·ª±c trang tr√≠ b√°nh"
    >
      <!-- Plate image behind cake and decorations -->
      <img
        id="plate-img"
        src=""
        alt="ƒêƒ©a trang tr√≠ b√°nh, h√¨nh tr√≤n, m√†u tr·∫Øng s√°ng, ki·ªÉu ƒë∆°n gi·∫£n"
        class="absolute top-[65%] left-[40%] -translate-x-1/2 -translate-y-1/2 w-64 h-64 object-contain pointer-events-none select-none"
        draggable="false"
        style="display:none"
      />
      <!-- Cake image -->
      <img
        id="cake-img"
        src=""
        alt="B√°nh mousse ba l·ªõp, h√¨nh tr√≤n, m√†u kem tr·∫Øng v√† h·ªìng nh·∫°t, trang tr√≠ ƒë∆°n gi·∫£n"
        class="absolute top-[60%] left-[40%] -translate-x-1/2 -translate-y-1/2 w-56 h-56 object-contain pointer-events-none select-none"
        draggable="false"
        style="display:none"
      />
      <!-- Decorations container -->
      <div
        id="decorations-container"
        class="absolute top-[60%] left-[40%] -translate-x-1/2 -translate-y-1/2 w-56 h-56 pointer-events-auto"
        aria-label="Khu v·ª±c trang tr√≠ ƒë·ªì trang tr√≠ tr√™n b√°nh"
      ></div>
    </div>

    <!-- Right vertical panel for selection steps -->
    <div
      id="right-panel"
      class="fixed top-0 right-0 h-full w-0 md:w-0 overflow-y-auto bg-white bg-opacity-90 backdrop-blur-md shadow-lg transition-all no-scrollbar flex flex-col"
      style="max-width: 15vw; min-width: 132px;"
      aria-live="polite"
      aria-atomic="true"
    >
    </div>

    <!-- Bottom right confirm and back buttons container (visible in steps 1,2,3) -->
    <div
      id="bottom-buttons"
      class="fixed bottom-20 right-4 left-4 flex justify-between max-w-md mx-auto px-2"
      style="max-width: 280px; display:none;"
    >
      <button
        id="btn-back-step"
        type="button"
        class="bg-gray-300 hover:bg-gray-400 active:bg-gray-500 text-gray-800 font-semibold rounded-full px-5 py-2 shadow-md transition disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Quay v·ªÅ
      </button>
      <button
        id="btn-confirm-step"
        type="button"
        class="bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-semibold rounded-full px-5 py-2 shadow-md transition disabled:opacity-50 disabled:cursor-not-allowed"
      >
        X√°c nh·∫≠n
      </button>
    </div>

    <!-- History modal -->
    <div
      id="history-modal"
      class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden"
      role="dialog"
      aria-modal="true"
      aria-labelledby="history-title"
    >
      <div class="bg-white rounded-lg max-w-md w-full max-h-[80vh] overflow-y-auto p-4 flex flex-col">
        <h2 id="history-title" class="text-xl font-bold mb-4 text-center">L·ªãch s·ª≠ b√°nh ƒë√£ trang tr√≠</h2>
        <div id="history-list" class="flex flex-col gap-4 overflow-y-auto no-scrollbar">
          <p class="text-center text-gray-600">Ch∆∞a c√≥ b√°nh ƒë√£ trang tr√≠ n√†o trong l·ªãch s·ª≠.</p>
        </div>
        <button
          id="btn-close-history"
          class="mt-6 bg-red-500 hover:bg-red-600 active:bg-red-700 text-white font-semibold rounded-full px-5 py-2 shadow-md self-center w-32"
          type="button"
        >
          ƒê√≥ng
        </button>
      </div>
    </div>
  </div>

  <script>
    (() => {
      // Elements
      const btnStart = document.getElementById("btn-start");
      const btnBackMain = document.getElementById("btn-back-main");
      const btnHistory = document.getElementById("btn-history");
      const btnCloseHistory = document.getElementById("btn-close-history");
      const historyModal = document.getElementById("history-modal");
      const historyList = document.getElementById("history-list");
      const rightPanel = document.getElementById("right-panel");
      const bottomButtons = document.getElementById("bottom-buttons");
      const btnBackStep = document.getElementById("btn-back-step");
      const btnConfirmStep = document.getElementById("btn-confirm-step");
      const cakeArea = document.getElementById("cake-area");
      const cakeImg = document.getElementById("cake-img");
      const plateImg = document.getElementById("plate-img");
      const decorationsContainer = document.getElementById("decorations-container");

      // Data
      // rewardInventory: cakes available to select (each only once)
      let rewardInventory = [
        {
          id: "mousse1",
          name: "Mousse cake ba l·ªõp",
          img: "https://i.ibb.co/jPFPXxkx/DA9957-E3-2-CB8-49-CA-BDEE-3-A897703-C3-DC.png",
          alt: "B√°nh mousse ba l·ªõp, h√¨nh tr√≤n, m√†u kem tr·∫Øng v√† h·ªìng nh·∫°t, trang tr√≠ ƒë∆°n gi·∫£n",
        },
        {
          id: "mousse2",
          name: "Mousse cake ba l·ªõp 2",
          img: "https://placehold.co/256x256/png?text=Mousse+Cake+2",
          alt: "B√°nh mousse ba l·ªõp, h√¨nh tr√≤n, m√†u kem tr·∫Øng v√† h·ªìng nh·∫°t, trang tr√≠ ƒë∆°n gi·∫£n, bi·∫øn th·ªÉ 2",
        },
        {
          id: "mousse3",
          name: "Mousse cake ba l·ªõp 3",
          img: "https://placehold.co/256x256/png?text=Mousse+Cake+3",
          alt: "B√°nh mousse ba l·ªõp, h√¨nh tr√≤n, m√†u kem tr·∫Øng v√† h·ªìng nh·∫°t, trang tr√≠ ƒë∆°n gi·∫£n, bi·∫øn th·ªÉ 3",
        },
        {
          id: "mousse4",
          name: "Mousse cake ba l·ªõp 4",
          img: "https://placehold.co/256x256/png?text=Mousse+Cake+4",
          alt: "B√°nh mousse ba l·ªõp, h√¨nh tr√≤n, m√†u kem tr·∫Øng v√† h·ªìng nh·∫°t, trang tr√≠ ƒë∆°n gi·∫£n, bi·∫øn th·ªÉ 4",
        },
        {
          id: "mousse5",
          name: "Mousse cake ba l·ªõp 5",
          img: "https://placehold.co/256x256/png?text=Mousse+Cake+5",
          alt: "B√°nh mousse ba l·ªõp, h√¨nh tr√≤n, m√†u kem tr·∫Øng v√† h·ªìng nh·∫°t, trang tr√≠ ƒë∆°n gi·∫£n, bi·∫øn th·ªÉ 5",
        },
        {
          id: "mousse6",
          name: "Mousse cake ba l·ªõp 6",
          img: "https://placehold.co/256x256/png?text=Mousse+Cake+6",
          alt: "B√°nh mousse ba l·ªõp, h√¨nh tr√≤n, m√†u kem tr·∫Øng v√† h·ªìng nh·∫°t, trang tr√≠ ƒë∆°n gi·∫£n, bi·∫øn th·ªÉ 6",
        },
        {
          id: "mousse7",
          name: "Mousse cake ba l·ªõp 7",
          img: "https://placehold.co/256x256/png?text=Mousse+Cake+7",
          alt: "B√°nh mousse ba l·ªõp, h√¨nh tr√≤n, m√†u kem tr·∫Øng v√† h·ªìng nh·∫°t, trang tr√≠ ƒë∆°n gi·∫£n, bi·∫øn th·ªÉ 7",
        },
        {
          id: "mousse8",
          name: "Mousse cake ba l·ªõp 8",
          img: "https://placehold.co/256x256/png?text=Mousse+Cake+8",
          alt: "B√°nh mousse ba l·ªõp, h√¨nh tr√≤n, m√†u kem tr·∫Øng v√† h·ªìng nh·∫°t, trang tr√≠ ƒë∆°n gi·∫£n, bi·∫øn th·ªÉ 8",
        },
        {
          id: "mousse9",
          name: "Mousse cake ba l·ªõp 9",
          img: "https://placehold.co/256x256/png?text=Mousse+Cake+9",
          alt: "B√°nh mousse ba l·ªõp, h√¨nh tr√≤n, m√†u kem tr·∫Øng v√† h·ªìng nh·∫°t, trang tr√≠ ƒë∆°n gi·∫£n, bi·∫øn th·ªÉ 9",
        },
        {
          id: "mousse10",
          name: "Mousse cake ba l·ªõp 10",
          img: "https://placehold.co/256x256/png?text=Mousse+Cake+10",
          alt: "B√°nh mousse ba l·ªõp, h√¨nh tr√≤n, m√†u kem tr·∫Øng v√† h·ªìng nh·∫°t, trang tr√≠ ƒë∆°n gi·∫£n, bi·∫øn th·ªÉ 10",
        },
        {
          id: "mousse11",
          name: "Mousse cake ba l·ªõp 11",
          img: "https://placehold.co/256x256/png?text=Mousse+Cake+11",
          alt: "B√°nh mousse ba l·ªõp, h√¨nh tr√≤n, m√†u kem tr·∫Øng v√† h·ªìng nh·∫°t, trang tr√≠ ƒë∆°n gi·∫£n, bi·∫øn th·ªÉ 11",
        },
        {
          id: "mousse12",
          name: "Mousse cake ba l·ªõp 12",
          img: "https://placehold.co/256x256/png?text=Mousse+Cake+12",
          alt: "B√°nh mousse ba l·ªõp, h√¨nh tr√≤n, m√†u kem tr·∫Øng v√† h·ªìng nh·∫°t, trang tr√≠ ƒë∆°n gi·∫£n, bi·∫øn th·ªÉ 12",
        },
        {
          id: "mousse13",
          name: "Mousse cake ba l·ªõp 13",
          img: "https://placehold.co/256x256/png?text=Mousse+Cake+13",
          alt: "B√°nh mousse ba l·ªõp, h√¨nh tr√≤n, m√†u kem tr·∫Øng v√† h·ªìng nh·∫°t, trang tr√≠ ƒë∆°n gi·∫£n, bi·∫øn th·ªÉ 13",
        },
        {
          id: "mousse14",
          name: "Mousse cake ba l·ªõp 14",
          img: "https://placehold.co/256x256/png?text=Mousse+Cake+14",
          alt: "B√°nh mousse ba l·ªõp, h√¨nh tr√≤n, m√†u kem tr·∫Øng v√† h·ªìng nh·∫°t, trang tr√≠ ƒë∆°n gi·∫£n, bi·∫øn th·ªÉ 14",
        },
        {
          id: "mousse15",
          name: "Mousse cake ba l·ªõp 15",
          img: "https://placehold.co/256x256/png?text=Mousse+Cake+15",
          alt: "B√°nh mousse ba l·ªõp, h√¨nh tr√≤n, m√†u kem tr·∫Øng v√† h·ªìng nh·∫°t, trang tr√≠ ƒë∆°n gi·∫£n, bi·∫øn th·ªÉ 15",
        },
      ];

      // Decorations (unlimited use)
      const decorations = [
        {
          id: "flower1",
          name: "Hoa",
          img: "https://i.ibb.co/jPFPXxkx/DA9957-E3-2-CB8-49-CA-BDEE-3-A897703-C3-DC.png",
          alt: "Hoa trang tr√≠ b√°nh m√†u h·ªìng nh·∫°t, h√¨nh tr√≤n, chi ti·∫øt c√°nh hoa m·ªÅm m·∫°i",
        },
        {
          id: "flower2",
          name: "Hoa 2",
          img: "https://placehold.co/64x64/png?text=Flower+2",
          alt: "Hoa trang tr√≠ b√°nh m√†u h·ªìng nh·∫°t, h√¨nh tr√≤n, chi ti·∫øt c√°nh hoa m·ªÅm m·∫°i, bi·∫øn th·ªÉ 2",
        },
        {
          id: "flower3",
          name: "Hoa 3",
          img: "https://placehold.co/64x64/png?text=Flower+3",
          alt: "Hoa trang tr√≠ b√°nh m√†u h·ªìng nh·∫°t, h√¨nh tr√≤n, chi ti·∫øt c√°nh hoa m·ªÅm m·∫°i, bi·∫øn th·ªÉ 3",
        },
        {
          id: "flower4",
          name: "Hoa 4",
          img: "https://placehold.co/64x64/png?text=Flower+4",
          alt: "Hoa trang tr√≠ b√°nh m√†u h·ªìng nh·∫°t, h√¨nh tr√≤n, chi ti·∫øt c√°nh hoa m·ªÅm m·∫°i, bi·∫øn th·ªÉ 4",
        },
        {
          id: "flower5",
          name: "Hoa 5",
          img: "https://placehold.co/64x64/png?text=Flower+5",
          alt: "Hoa trang tr√≠ b√°nh m√†u h·ªìng nh·∫°t, h√¨nh tr√≤n, chi ti·∫øt c√°nh hoa m·ªÅm m·∫°i, bi·∫øn th·ªÉ 5",
        },
      ];

      // Plates (unlimited use)
      const plates = [
        {
          id: "plate1",
          name: "B√°nh quy",
          img: "https://i.ibb.co/1f7QddJr/B374185-B-BEFF-4777-92-A0-267-C737-C5-C70.png",
          alt: "ƒêƒ©a b√°nh quy h√¨nh tr√≤n, m√†u tr·∫Øng s√°ng, ki·ªÉu ƒë∆°n gi·∫£n",
        },
        {
          id: "plate2",
          name: "ƒêƒ©a g·ªëm xanh",
          img: "https://placehold.co/256x256/png?text=Blue+Ceramic+Plate",
          alt: "ƒêƒ©a g·ªëm m√†u xanh d∆∞∆°ng, h√¨nh tr√≤n, ki·ªÉu ƒë∆°n gi·∫£n",
        },
        {
          id: "plate3",
          name: "ƒêƒ©a g·ªó",
          img: "https://placehold.co/256x256/png?text=Wooden+Plate",
          alt: "ƒêƒ©a g·ªó tr√≤n m√†u n√¢u s√°ng, ki·ªÉu ƒë∆°n gi·∫£n",
        },
      ];

      // History of decorated cakes
      let history = [];

      // State machine steps: 'idle', 'selectCake', 'selectDecorations', 'selectPlate', 'finished'
      let step = "idle";

      // Selected items
      let selectedCake = null; // cake object
      let selectedDecorations = []; // array of decoration objects with position and scale
      let selectedPlate = null; // plate object

      // Decoration drag state
      let dragState = {
        dragging: false,
        target: null,
        startX: 0,
        startY: 0,
        origX: 0,
        origY: 0,
        origScale: 1,
        index: null,
      };

      // Helpers
      function clearRightPanel() {
        rightPanel.innerHTML = "";
      }

      function enableConfirmButton(enabled) {
        btnConfirmStep.disabled = !enabled;
      }

      function showBottomButtons(show) {
        bottomButtons.style.display = show ? "flex" : "none";
      }

      function resetDecorationDrag() {
        dragState.dragging = false;
        dragState.target = null;
        dragState.index = null;
      }

      // Update cake area images immediately after cake or plate selection
      function updateCakeAreaDisplay() {
        if (selectedCake) {
          cakeImg.src = selectedCake.img;
          cakeImg.alt = selectedCake.alt;
          cakeImg.style.display = "block";
        } else {
          cakeImg.style.display = "none";
          cakeImg.src = "";
          cakeImg.alt = "";
        }
        if (selectedPlate) {
          plateImg.src = selectedPlate.img;
          plateImg.alt = selectedPlate.alt;
          plateImg.style.display = "block";
        } else {
          plateImg.style.display = "none";
          plateImg.src = "";
          plateImg.alt = "";
        }
        renderDecorations();
      }

      // Render functions for each step
      function renderSelectCake() {
        step = "selectCake";
        clearRightPanel();
        showBottomButtons(true);
        btnBackStep.disabled = true; // no back from step 1 to idle
        enableConfirmButton(selectedCake !== null);

        // Title
        const title = document.createElement("h2");
        title.textContent = "Ch·ªçn b√°nh";
        title.className = "text-xl font-bold p-4 border-b border-gray-300 sticky top-0 bg-white z-10";
        rightPanel.appendChild(title);

        // Container for cake list
        const list = document.createElement("div");
        list.className = "flex flex-col gap-3 p-4 overflow-y-auto no-scrollbar";
        list.style.minHeight = "100%";

        // For each cake in rewardInventory, show item with radio button
        rewardInventory.forEach((cake) => {
          const item = document.createElement("label");
          item.className =
            "flex items-center gap-3 p-2 rounded-lg cursor-pointer border border-gray-300 hover:border-green-600 transition";

          const radio = document.createElement("input");
          radio.type = "radio";
          radio.name = "cake-select";
          radio.value = cake.id;
          radio.className = "w-5 h-5 cursor-pointer";
          radio.checked = selectedCake && selectedCake.id === cake.id;
          radio.setAttribute("aria-label", cake.name);

          radio.addEventListener("change", () => {
            selectedCake = cake;
            enableConfirmButton(true);
            updateCakeAreaDisplay();
          });

          const img = document.createElement("img");
          img.src = cake.img;
          img.alt = cake.alt;
          img.className = "w-16 h-16 object-contain select-none pointer-events-none rounded-md";

          const nameSpan = document.createElement("span");
          nameSpan.textContent = cake.name;
          nameSpan.className = "text-gray-800 font-medium";

          item.appendChild(radio);
          item.appendChild(img);
          item.appendChild(nameSpan);

          list.appendChild(item);
        });

        rightPanel.appendChild(list);

        // Show right panel with width 15vw
        rightPanel.style.width = "15vw";
        rightPanel.style.minWidth = "132px";

        // Shift cake area
        cakeArea.classList.add("shifted");

        // Clear plate and decorations
        selectedPlate = null;
        decorationsContainer.innerHTML = "";
        updateCakeAreaDisplay();
      }

      function renderSelectDecorations() {
        step = "selectDecorations";
        clearRightPanel();
        showBottomButtons(true);
        btnBackStep.disabled = false;
        enableConfirmButton(true); // can confirm even if no decoration selected

        // Title
        const title = document.createElement("h2");
        title.textContent = "Ch·ªçn ƒë·ªì trang tr√≠";
        title.className = "text-xl font-bold p-4 border-b border-gray-300 sticky top-0 bg-white z-10";
        rightPanel.appendChild(title);

        // Container for decorations list
        const list = document.createElement("div");
        list.className = "flex flex-col gap-3 p-4 overflow-y-auto no-scrollbar";
        list.style.minHeight = "100%";

        // Decorations can be selected multiple times, so show as buttons to add
        decorations.forEach((dec) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className =
            "flex items-center gap-3 p-2 rounded-lg cursor-pointer border border-gray-300 hover:border-green-600 transition w-full";

          btn.setAttribute("aria-label", `Th√™m ƒë·ªì trang tr√≠: ${dec.name}`);

          const img = document.createElement("img");
          img.src = dec.img;
          img.alt = dec.alt;
          img.className = "w-12 h-12 object-contain select-none pointer-events-none rounded-md";

          const nameSpan = document.createElement("span");
          nameSpan.textContent = dec.name;
          nameSpan.className = "text-gray-800 font-medium";

          btn.appendChild(img);
          btn.appendChild(nameSpan);

          btn.addEventListener("click", () => {
            addDecoration(dec);
          });

          list.appendChild(btn);
        });

        rightPanel.appendChild(list);

        // Show right panel with width 15vw
        rightPanel.style.width = "15vw";
        rightPanel.style.minWidth = "132px";

        // Ensure cake area shifted
        cakeArea.classList.add("shifted");

        updateCakeAreaDisplay();
      }

      function renderSelectPlate() {
        step = "selectPlate";
        clearRightPanel();
        showBottomButtons(true);
        btnBackStep.disabled = false;
        enableConfirmButton(selectedPlate !== null);

        // Title
        const title = document.createElement("h2");
        title.textContent = "Ch·ªçn ƒëƒ©a";
        title.className = "text-xl font-bold p-4 border-b border-gray-300 sticky top-0 bg-white z-10";
        rightPanel.appendChild(title);

        // Container for plates list
        const list = document.createElement("div");
        list.className = "flex flex-col gap-3 p-4 overflow-y-auto no-scrollbar";
        list.style.minHeight = "100%";

        plates.forEach((plate) => {
          const item = document.createElement("label");
          item.className =
            "flex items-center gap-3 p-2 rounded-lg cursor-pointer border border-gray-300 hover:border-green-600 transition";

          const radio = document.createElement("input");
          radio.type = "radio";
          radio.name = "plate-select";
          radio.value = plate.id;
          radio.className = "w-5 h-5 cursor-pointer";
          radio.checked = selectedPlate && selectedPlate.id === plate.id;
          radio.setAttribute("aria-label", plate.name);

          radio.addEventListener("change", () => {
            selectedPlate = plate;
            enableConfirmButton(true);
            updateCakeAreaDisplay();
          });

          const img = document.createElement("img");
          img.src = plate.img;
          img.alt = plate.alt;
          img.className = "w-16 h-16 object-contain select-none pointer-events-none rounded-md";

          const nameSpan = document.createElement("span");
          nameSpan.textContent = plate.name;
          nameSpan.className = "text-gray-800 font-medium";

          item.appendChild(radio);
          item.appendChild(img);
          item.appendChild(nameSpan);

          list.appendChild(item);
        });

        rightPanel.appendChild(list);

        // Show right panel with width 15vw
        rightPanel.style.width = "15vw";
        rightPanel.style.minWidth = "132px";

        // Ensure cake area shifted
        cakeArea.classList.add("shifted");

        updateCakeAreaDisplay();
      }

      function renderDecorations() {
        decorationsContainer.innerHTML = "";
        selectedDecorations.forEach((dec, index) => {
          const decEl = document.createElement("img");
          decEl.src = dec.img;
          decEl.alt = dec.alt;
          decEl.className = "absolute select-none";
          decEl.style.left = dec.x + "px";
          decEl.style.top = dec.y + "px";
          decEl.style.width = dec.scale * 64 + "px";
          decEl.style.height = "auto";
          decEl.style.transformOrigin = "center center";
          decEl.style.userSelect = "none";
          decEl.style.touchAction = "none";
          decEl.setAttribute("data-index", index);
          decEl.setAttribute("aria-label", `ƒê·ªì trang tr√≠: ${dec.name}`);

          // Add pointer events for drag only if in selectDecorations step
          if (step === "selectDecorations") {
            decEl.classList.add("cursor-move");
            decEl.addEventListener("pointerdown", onDecorationPointerDown);
          } else {
            decEl.classList.remove("cursor-move");
            decEl.removeEventListener("pointerdown", onDecorationPointerDown);
          }

          decorationsContainer.appendChild(decEl);
        });
      }

      // Add a decoration at center of cake area with default scale 1
      function addDecoration(dec) {
        // Position relative to decorationsContainer (which is 224x224 approx)
        // We'll place new decoration at center (112,112)
        const x = decorationsContainer.clientWidth / 2 - 32; // center minus half width of decoration (64/2)
        const y = decorationsContainer.clientHeight / 2 - 32;

        selectedDecorations.push({
          ...dec,
          x,
          y,
          scale: 1,
          name: dec.name,
          img: dec.img,
          alt: dec.alt,
        });
        renderDecorations();
      }

      // Drag handlers for decorations
      function onDecorationPointerDown(e) {
        e.preventDefault();
        if (step !== "selectDecorations") return; // Only allow drag in selectDecorations step

        const target = e.currentTarget;
        const index = Number(target.getAttribute("data-index"));
        if (isNaN(index)) return;

        dragState.dragging = true;
        dragState.target = target;
        dragState.startX = e.clientX;
        dragState.startY = e.clientY;
        dragState.origX = selectedDecorations[index].x;
        dragState.origY = selectedDecorations[index].y;
        dragState.origScale = selectedDecorations[index].scale;
        dragState.index = index;

        target.setPointerCapture(e.pointerId);

        target.style.transition = "none";

        window.addEventListener("pointermove", onDecorationPointerMove);
        window.addEventListener("pointerup", onDecorationPointerUp);
        window.addEventListener("pointercancel", onDecorationPointerUp);
      }

      function onDecorationPointerMove(e) {
        if (!dragState.dragging) return;
        e.preventDefault();

        const dx = e.clientX - dragState.startX;
        const dy = e.clientY - dragState.startY;

        let newX = dragState.origX + dx;
        let newY = dragState.origY + dy;

        // Clamp inside decorationsContainer boundaries (allow some overflow)
        const maxX = decorationsContainer.clientWidth - 32;
        const maxY = decorationsContainer.clientHeight - 32;
        const minX = -32;
        const minY = -32;

        if (newX < minX) newX = minX;
        if (newX > maxX) newX = maxX;
        if (newY < minY) newY = minY;
        if (newY > maxY) newY = maxY;

        // Update position
        selectedDecorations[dragState.index].x = newX;
        selectedDecorations[dragState.index].y = newY;

        // Update scale based on vertical movement:
        // Moving up (dy negative) ‚Üí scale down to min 0.5
        // Moving down (dy positive) ‚Üí scale up to max 1.5
        // Scale changes linearly with dy, max range ¬±100px
        let scale = dragState.origScale;
        if (dy < 0) {
          // up - smaller
          scale = Math.max(0.5, dragState.origScale - (-dy) / 200);
        } else {
          // down - bigger
          scale = Math.min(1.5, dragState.origScale + dy / 200);
        }
        selectedDecorations[dragState.index].scale = scale;

        renderDecorations();
      }

      function onDecorationPointerUp(e) {
        if (!dragState.dragging) return;
        e.preventDefault();

        dragState.target.style.transition = "";

        dragState.dragging = false;
        dragState.target = null;
        dragState.index = null;

        window.removeEventListener("pointermove", onDecorationPointerMove);
        window.removeEventListener("pointerup", onDecorationPointerUp);
        window.removeEventListener("pointercancel", onDecorationPointerUp);
      }

      // Clear all selections and reset to idle
      function resetAll() {
        step = "idle";
        selectedCake = null;
        selectedDecorations = [];
        selectedPlate = null;
        rightPanel.style.width = "0";
        rightPanel.style.minWidth = "0";
        showBottomButtons(false);
        cakeImg.style.display = "none";
        plateImg.style.display = "none";
        decorationsContainer.innerHTML = "";
        btnConfirmStep.disabled = true;
        cakeArea.classList.remove("shifted");
      }

      // Save current decorated cake to history and update inventory
      function saveDecoratedCake() {
        // Compose decorated cake object
        const decoratedCake = {
          id: `decorated_${Date.now()}`,
          cake: selectedCake,
          decorations: JSON.parse(JSON.stringify(selectedDecorations)),
          plate: selectedPlate,
        };
        history.push(decoratedCake);

        // Remove used cake from rewardInventory
        rewardInventory = rewardInventory.filter((c) => c.id !== selectedCake.id);

        // Reset selections except history
        selectedCake = null;
        selectedDecorations = [];
        selectedPlate = null;

        // Reset UI to idle but show final cake on screen
        step = "finished";
        rightPanel.style.width = "0";
        rightPanel.style.minWidth = "0";
        showBottomButtons(false);

        // Show cake + decorations + plate on cake area
        cakeImg.style.display = "block";
        cakeImg.src = decoratedCake.cake.img;
        cakeImg.alt = decoratedCake.cake.alt;

        plateImg.style.display = "block";
        plateImg.src = decoratedCake.plate.img;
        plateImg.alt = decoratedCake.plate.alt;

        // Render decorations
        selectedDecorations = decoratedCake.decorations;
        renderDecorations();

        // Disable start button if no cakes left
        btnStart.disabled = rewardInventory.length === 0;

        // Remove shift from cake area
        cakeArea.classList.remove("shifted");
      }

      // Render history modal list
      function renderHistory() {
        historyList.innerHTML = "";
        if (history.length === 0) {
          const emptyMsg = document.createElement("p");
          emptyMsg.textContent = "Ch∆∞a c√≥ b√°nh ƒë√£ trang tr√≠ n√†o trong l·ªãch s·ª≠.";
          emptyMsg.className = "text-center text-gray-600";
          historyList.appendChild(emptyMsg);
          return;
        }

        history.forEach((item) => {
          const container = document.createElement("div");
          container.className = "flex gap-3 items-center border border-gray-300 rounded-lg p-2";

          // Plate behind cake + decorations
          const plateWrapper = document.createElement("div");
          plateWrapper.className = "relative w-20 h-20 flex-shrink-0";

          const plateImgEl = document.createElement("img");
          plateImgEl.src = item.plate.img;
          plateImgEl.alt = item.plate.alt;
          plateImgEl.className = "absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-20 h-20 object-contain select-none pointer-events-none";
          plateWrapper.appendChild(plateImgEl);

          const cakeImgEl = document.createElement("img");
          cakeImgEl.src = item.cake.img;
          cakeImgEl.alt = item.cake.alt;
          cakeImgEl.className = "absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-16 h-16 object-contain select-none pointer-events-none";
          plateWrapper.appendChild(cakeImgEl);

          // Decorations container
          const decContainer = document.createElement("div");
          decContainer.className = "absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-16 h-16 pointer-events-none";
          item.decorations.forEach((dec) => {
            const decEl = document.createElement("img");
            decEl.src = dec.img;
            decEl.alt = dec.alt;
            decEl.className = "absolute select-none";
            decEl.style.left = dec.x * (16 / 56) + "px"; // scale position from 56 to 16
            decEl.style.top = dec.y * (16 / 56) + "px";
            decEl.style.width = dec.scale * (64 * 16 / 56) + "px";
            decEl.style.height = "auto";
            decContainer.appendChild(decEl);
          });
          plateWrapper.appendChild(decContainer);

          container.appendChild(plateWrapper);

          // Info text
          const info = document.createElement("div");
          info.className = "flex flex-col";

          const cakeName = document.createElement("p");
          cakeName.textContent = item.cake.name;
          cakeName.className = "font-semibold text-gray-800";

          const plateName = document.createElement("p");
          plateName.textContent = `ƒêƒ©a: ${item.plate.name}`;
          plateName.className = "text-gray-600 text-sm";

          const decNames = item.decorations.length
            ? item.decorations.map((d) => d.name).join(", ")
            : "Kh√¥ng c√≥ ƒë·ªì trang tr√≠";
          const decText = document.createElement("p");
          decText.textContent = `Trang tr√≠: ${decNames}`;
          decText.className = "text-gray-600 text-sm truncate max-w-xs";

          info.appendChild(cakeName);
          info.appendChild(plateName);
          info.appendChild(decText);

          container.appendChild(info);

          historyList.appendChild(container);
        });
      }

      // Event listeners
      btnStart.addEventListener("click", () => {
        if (rewardInventory.length === 0) {
          alert("Kh√¥ng c√≤n b√°nh n√†o ƒë·ªÉ ch·ªçn.");
          return;
        }
        selectedCake = null;
        selectedDecorations = [];
        selectedPlate = null;
        renderSelectCake();
        btnStart.style.display = "none";
      });

      btnBackMain.addEventListener("click", () => {
        // Reset all and show start button
        resetAll();
        btnStart.style.display = "block";
      });

      btnHistory.addEventListener("click", () => {
        renderHistory();
        historyModal.classList.remove("hidden");
      });

      btnCloseHistory.addEventListener("click", () => {
        historyModal.classList.add("hidden");
      });

      btnBackStep.addEventListener("click", () => {
        if (step === "selectDecorations") {
          // Back to select cake
          renderSelectCake();
        } else if (step === "selectPlate") {
          // Back to select decorations
          renderSelectDecorations();
        }
      });

      btnConfirmStep.addEventListener("click", () => {
        if (step === "selectCake") {
          if (!selectedCake) return;
          renderSelectDecorations();
        } else if (step === "selectDecorations") {
          renderSelectPlate();
        } else if (step === "selectPlate") {
          if (!selectedPlate) return;
          saveDecoratedCake();
          btnStart.style.display = "block";
        }
      });

      // Initialize UI
      resetAll();
    })();
  </script>
</body>
</html>
