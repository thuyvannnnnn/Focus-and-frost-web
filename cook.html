<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trang-ch·ªß - ·ª®ng d·ª•ng t·∫≠p trung</title>
  <script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>


  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f0f3e8;
    }
    /* Scrollbar for menu */
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background: transparent;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: #9bba74;
      border-radius: 3px;
    }
    /* Statistics modal content: no grid, just images in a row wrapping naturally */
#cake-list {
  list-style: none;
  padding: 0;
  margin: 0;
  max-height: 70vh;
  overflow-y: auto;
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  justify-content: flex-start;
  align-items: center;
}
#cake-list li {
  background: transparent;
  padding: 0;
  cursor: pointer;
  outline: none;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  display: inline-flex;
  justify-content: center;
  align-items: center;
  border-radius: 0.5rem;
}
#cake-list li:focus,
#cake-list li:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 8px rgb(0 0 0 / 0.2);
  z-index: 10;
}
#cake-list li img {
  width: 64px;
  height: 64px;
  object-fit: contain;
  border-radius: 0.5rem;
  user-select: none;
  pointer-events: none;
  display: block;
}
#cake-list li span {
  display: none;
}
@media (max-width: 480px) {
  #cake-list li img {
    width: 48px;
    height: 48px;
  }
}

/* Hi·ªáu ·ª©ng chuy·ªÉn ƒë·ªïi khung */
#reward-view,
#chart-view {
  transition: opacity 0.3s ease, transform 0.3s ease;
}
.hidden {
  display: none !important;
  opacity: 0;
  transform: scale(0.95);
}
.visible {
  display: block;
  opacity: 1;
  transform: scale(1);
}

/* Style cho 2 n√∫t tab */
.tab-btn {
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  border: 2px solid #FF69B4;
  color: #FF69B4;
  font-weight: 600;
  transition: all 0.2s ease;
}
.tab-btn.active {
  background: #FF69B4;
  color: white;
  box-shadow: 0 4px 8px rgb(0 0 0 / 0.2);
}


    /* Custom styles for Google SignIn button container */
    #googleSignInButton {
      position: relative;
      left: -15%;
      width: 10rem !important; /* override width to accommodate bigger button */
      height: 2.5rem !important; /* override height */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /* Avatar style */
    #userAvatar {
      width: 40px;
      height: 40px;
      border-radius: 9999px;
      object-fit: cover;
      cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
      transition: transform 0.2s ease;
    }
    #userAvatar:hover, #userAvatar:focus {
      transform: scale(1.1);
      outline: none;
      box-shadow: 0 0 8px rgba(0,0,0,0.4);
    }
  </style>
</head>
<body class="relative min-h-screen flex flex-col items-center bg-[#f0f3e8]">
  <!-- Background Image -->
  <img
    src="https://i.ibb.co/JRr5YSFS/66-F84-D93-7422-4-D12-AD64-8-B3103-E20-BD3.png"
    alt="Background with soft green and beige abstract shapes, watercolor style, gentle and calming atmosphere"
    class="fixed inset-0 w-full h-full object-cover -z-10"
  />

  <!-- Header with Google Login / Logout Button and Avatar -->
  <header class="w-full flex justify-end p-4 max-w-screen-md relative">
    <div id="googleSignInButton" class="w-10 h-10"></div>
    <button
      id="googleLogoutBtn"
      aria-label="ƒêƒÉng xu·∫•t t√†i kho·∫£n Google"
      class="fixed top-4 right-4 z-50 flex items-center justify-center w-10 h-10 
         rounded-full bg-[#9BBA74] hover:bg-[#8aa85a] text-white font-semibold shadow 
         focus:outline-none focus:ring-2 focus:ring-[#8aa85a]"
      type="button"
      title="ƒêƒÉng xu·∫•t"
    >
      <i class="fas fa-arrow-right"></i>
    </button>
    <img
      id="userAvatar"
      src=""
      alt="·∫¢nh ƒë·∫°i di·ªán ng∆∞·ªùi d√πng Google"
      class="hidden absolute top-4 left-4"
      tabindex="0"
      aria-label="·∫¢nh ƒë·∫°i di·ªán ng∆∞·ªùi d√πng Google"
      draggable="false"
    />
  </header>

  <!-- Main Content -->
  <main
    class="flex-grow flex flex-col items-center justify-center px-4 pb-20 relative w-full max-w-screen-md"
    aria-label="M√†n h√¨nh ch√≠nh ·ª©ng d·ª•ng t·∫≠p trung"
  >
    <!-- Time selector rectangle above circle with progress bar -->
    <div
      id="time-selector"
      class="mb-6 w-full max-w-xs rounded-lg border-4 border-[#9BBA74] bg-white bg-opacity-90 p-4 flex flex-col select-none"
      aria-label="Ch·ªçn th·ªùi gian gi·ªù ph√∫t gi√¢y"
    >
      <div class="relative w-full h-10 rounded bg-gray-200 overflow-hidden mb-2" aria-hidden="true">
        <div id="time-progress-bar" class="absolute left-0 top-0 h-10 bg-[#9BBA74] transition-all duration-500 ease-linear" style="width: 100%;"></div>
      </div>
      <div class="flex justify-center space-x-2 z-10 relative">
        <input
          type="number"
          id="input-hour"
          min="0"
          max="23"
          placeholder="Gi·ªù"
          class="w-16 text-center rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#9BBA74] text-lg font-semibold bg-transparent"
          aria-label="Gi·ªù"
        />
        <span class="text-xl font-semibold text-gray-700 select-none">:</span>
        <input
          type="number"
          id="input-minute"
          min="0"
          max="59"
          placeholder="Ph√∫t"
          class="w-16 text-center rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#9BBA74] text-lg font-semibold bg-transparent"
          aria-label="Ph√∫t"
        />
        <span class="text-xl font-semibold text-gray-700 select-none">:</span>
        <input
          type="number"
          id="input-second"
          min="0"
          max="59"
          placeholder="Gi√¢y"
          class="w-16 text-center rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#9BBA74] text-lg font-semibold bg-transparent"
          aria-label="Gi√¢y"
        />
      </div>
    </div>

    <!-- Circle with selected cake image -->
    <button
      id="circle-cake"
      aria-label="Ch·ªçn m√≥n ƒÉn"
      class="relative rounded-full border-8 border-[#9BBA74] w-56 h-56 flex items-center justify-center overflow-hidden shadow-lg bg-white"
      type="button"
    >
      <img
        id="cake-image"
        src="https://raw.githubusercontent.com/thuyvannnnnn/Focus-and-frost/main/00CC2FB6-9ED5-4466-9DDB-C7B89C391BB1.png"
        alt="H√¨nh ·∫£nh Macaron m√†u h·ªìng pastel, b√°nh ng·ªçt tr√≤n nh·ªè xinh x·∫Øn, n·ªÅn tr·∫Øng"
        class="w-40 h-40 object-contain"
        draggable="false"
      />
      <!-- GIF overlay hidden by default -->
      <img
        id="cooking-gif"
        src="https://i.ibb.co/S4dcjq9g/Video.gif"
        alt="H√¨nh ·∫£nh GIF ho·∫°t h√¨nh b√°nh ƒëang ƒë∆∞·ª£c n·∫•u, m√†u s·∫Øc t∆∞∆°i s√°ng, n·ªÅn trong su·ªët"
        class="absolute inset-0 w-full h-full object-contain hidden"
        draggable="false"
      />
    </button>

    <!-- Selected cake name rectangle below circle -->
    <div
      id="selected-cake-name"
      class="mt-6 w-full max-w-xs rounded-lg border-4 border-[#9BBA74] bg-white bg-opacity-90 p-3 text-center text-xl font-semibold text-gray-800 select-none min-h-[3rem]"
      aria-live="polite"
      aria-atomic="true"
    >
      Macaron
    </div>

    <!-- Bottom rectangle with buttons -->
    <div
      class="mt-6 w-full max-w-xs rounded-lg border-4 border-[#9BBA74] bg-white bg-opacity-90 p-4 flex items-center justify-between"
      aria-label="C√°c n√∫t ƒëi·ªÅu khi·ªÉn"
    >
      <!-- Left side buttons -->
      <div class="flex space-x-4">
        <button
          id="btn-statistics"
          aria-label="B·∫£ng th·ªëng k√™ d·∫°ng l∆∞·ªõi"
          class="w-11 h-11 rounded-full bg-[#9BBA74] hover:bg-[#8aa85a] flex items-center justify-center text-white shadow focus:outline-none focus:ring-2 focus:ring-[#8aa85a]"
          type="button"
        >
          <i class="fas fa-chart-bar text-lg"></i>
        </button>
      </div>

 <!-- Center Start/Stop/Use Reward button -->
      <button
        id="btn-start-stop"
        class="flex-1 mx-4 py-2 rounded-lg font-bold text-white disabled:opacity-50 disabled:cursor-not-allowed bg-[#9BBA74] hover:bg-[#8aa85a] focus:outline-none focus:ring-2 focus:ring-[#8aa85a]"
        type="button"
        aria-live="polite"
        aria-atomic="true"
      >
        B·∫Øt ƒë·∫ßu
      </button>


       <!-- Hidden feedback form for submission -->
    <form
      id="feedback-form"
      action="https://formspree.io/f/mzzvylbg"
      method="POST"
      class="hidden"
    >
      <label>
        <input type="email" name="thuyvan01012008@gmail.com" value="madebyvann" />
      </label>
      <input type="hidden" name="message" id="feedback-message" />
    </form>
  </main>

  <!-- Feedback button bottom right -->
  <button
    id="btn-feedback"
    aria-label="G√≥p √Ω"
    class="fixed bottom-6 right-6 w-14 h-14 rounded-full bg-[#9BBA74] hover:bg-[#8aa85a] flex items-center justify-center text-white shadow-lg z-50 focus:outline-none focus:ring-2 focus:ring-[#8aa85a]"
    type="button"
    title="G√≥p √Ω"
  >
    <i class="fas fa-comment-alt text-xl"></i>
  </button>
  <button
    id="infoToggleBtn"
    aria-label="Toggle information panel"
    class="fixed top-4 left-1/2 -translate-x-1/2 z-50 w-10 h-10 flex items-center justify-center 
         rounded-full bg-[#9BBA74] hover:bg-[#8aa85a] text-white shadow"
  >
    <i class="fas fa-question text-lg"></i>
?
  </button>

  <!-- Logout Confirmation Modal -->
  <div
    id="logout-confirm-modal"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden"
    role="dialog"
    aria-modal="true"
    aria-labelledby="logout-confirm-title"
  >
    <div class="bg-white rounded-lg max-w-sm w-full p-6 flex flex-col space-y-4 shadow-lg">
      <h2 id="logout-confirm-title" class="text-xl font-semibold text-gray-800 text-center">
        B·∫°n c√≥ mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?
      </h2>
      <div class="flex justify-center space-x-6">
        <button
          id="logout-yes-btn"
          class="px-6 py-2 rounded bg-[#DC143C] hover:bg-[#b0102a] text-white font-semibold focus:outline-none focus:ring-2 focus:ring-[#b0102a]"
          type="button"
        >
          C√≥
        </button>
        <button
          id="logout-no-btn"
          class="px-6 py-2 rounded bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold focus:outline-none focus:ring-2 focus:ring-gray-400"
          type="button"
        >
          Kh√¥ng
        </button>
      </div>
    </div>
  </div>

  <!-- Menu ch·ªçn m√≥n (hidden by default) -->
  <div
    id="menu-select-cake"
    class="fixed bottom-32 left-1/2 transform -translate-x-1/2 w-full max-w-md max-h-60 bg-white bg-opacity-95 rounded-lg border border-gray-300 shadow-lg overflow-y-auto scrollbar-thin hidden z-40"
    role="list"
    aria-label="Menu ch·ªçn m√≥n ƒÉn"
  >
    <div id="menu-cake-list" class="flex flex-wrap justify-center gap-4 p-4">
      <button type="button" class="flex flex-col items-center space-y-1 focus:outline-none focus:ring-2 focus:ring-[#9BBA74] rounded" data-cake="Macaron" aria-label="Ch·ªçn m√≥n Macaron">
        <img src="https://raw.githubusercontent.com/thuyvannnnnn/Focus-and-frost/main/00CC2FB6-9ED5-4466-9DDB-C7B89C391BB1.png" alt="H√¨nh ·∫£nh Macaron m√†u h·ªìng pastel, b√°nh ng·ªçt tr√≤n nh·ªè xinh x·∫Øn, n·ªÅn tr·∫Øng" class="w-14 h-14 object-contain" draggable="false" />
        <span class="text-sm font-semibold text-gray-700">Macaron</span>
      </button>
      <button type="button" class="flex flex-col items-center space-y-1 focus:outline-none focus:ring-2 focus:ring-[#9BBA74] rounded" data-cake="b√°nh m√¢m x√¥i" aria-label="Ch·ªçn m√≥n b√°nh m√¢m x√¥i">
        <img src="https://raw.githubusercontent.com/thuyvannnnnn/Focus-and-frost/main/IMG_7293.png" alt="H√¨nh ·∫£nh qu·∫£ c√† t√≠m t√≠m t∆∞∆°i, b√≥ng m∆∞·ª£t, n·ªÅn tr·∫Øng" class="w-14 h-14 object-contain" draggable="false" />
        <span class="text-sm font-semibold text-gray-700">b√°nh m√¢m x√¥i</span>
      </button>
      <button type="button" class="flex flex-col items-center space-y-1 focus:outline-none focus:ring-2 focus:ring-[#9BBA74] rounded" data-cake="b√°nh cherry" aria-label="Ch·ªçn m√≥n b√°nh cherry">
        <img src="https://raw.githubusercontent.com/thuyvannnnnn/Focus-and-frost/main/B89384A0-0587-48F6-BBCB-4EC98C592F1C.png" alt="H√¨nh ·∫£nh b√°nh cherry m√†u ƒë·ªè t∆∞∆°i, b√°nh tr√≤n nh·ªè, n·ªÅn tr·∫Øng" class="w-14 h-14 object-contain" draggable="false" />
        <span class="text-sm font-semibold text-gray-700">b√°nh cherry</span>
      </button>
    </div>
  </div>

  <!-- Reward modal -->
  <div
    id="reward-modal"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden"
    role="dialog"
    aria-modal="true"
    aria-labelledby="reward-title"
  >
    <div
      class="bg-white rounded-lg max-w-md w-full p-6 flex flex-col space-y-4 shadow-lg relative"
    >
      <h2
        id="reward-title"
        class="text-xl font-semibold text-gray-800 text-center"
      >
        Hoan h√¥! B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c
      </h2>
      <div
        id="reward-content"
        class="flex flex-row items-center justify-center space-x-4 flex-wrap"
        aria-live="polite"
        aria-atomic="true"
      >
      </div>
      <button
        id="reward-confirm"
        class="mt-4 px-6 py-2 rounded bg-[#DC143C] hover:bg-[#b0102a] text-white font-semibold mx-auto focus:outline-none focus:ring-2 focus:ring-[#b0102a]"
        type="button"
      >
        X√°c nh·∫≠n
      </button>
      <button
        id="reward-close"
        aria-label="ƒê√≥ng b·∫£ng hoan h√¥"
        class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 focus:outline-none focus:ring-2 focus:ring-[#b0102a] rounded"
        type="button"
      >
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>
  </div>

  <!-- Statistics modal with scrollable images -->
<div
  id="statistics-modal"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden"
  role="dialog"
  aria-modal="true"
  aria-labelledby="statistics-title"
>
  <div class="bg-white rounded-lg max-w-md w-full p-6 flex flex-col space-y-4 shadow-lg max-h-[90vh] overflow-y-auto">
    <h2 id="statistics-title" class="text-2xl font-bold text-center text-gray-800 mb-4">
      L·ªãch s·ª≠
    </h2>

    <!-- N√∫t chuy·ªÉn tab -->
    <div class="flex justify-center space-x-4">
      <button id="btn-reward" class="tab-btn active">üéÅ Ph·∫ßn th∆∞·ªüng</button>
      <button id="btn-chart" class="tab-btn">üìä Bi·ªÉu ƒë·ªì</button>
    </div>

    <!-- Khung 1: ph·∫ßn th∆∞·ªüng -->
    <div id="reward-view" class="visible">
      <ul id="cake-list" tabindex="0" aria-label="l·ªãch s·ª≠ t·∫≠p trung">
        <li tabindex="0" role="button" aria-label="Ph·∫ßn th∆∞·ªüng: b√°nh m√¢m x√¥i, ng√†y nh·∫≠n: 2024-06-14, th·ªùi gian nh·∫≠n: 21:30, th·ªùi l∆∞·ª£ng: 18 ph√∫t" class="cursor-pointer rounded">
               </li>
        <li tabindex="0" role="button" aria-label="Ph·∫ßn th∆∞·ªüng: b√°nh cherry, ng√†y nh·∫≠n: 2024-06-15, th·ªùi gian nh·∫≠n: 22:45, th·ªùi l∆∞·ª£ng: 22 ph√∫t" class="cursor-pointer rounded">
          <img src="https://raw.githubusercontent.com/thuyvannnnnn/Focus-and-frost/main/B89384A0-0587-48F6-BBCB-4EC98C592F1C.png" alt="H√¨nh ·∫£nh b√°nh cherry m√†u ƒë·ªè t∆∞∆°i, b√°nh tr√≤n nh·ªè, n·ªÅn tr·∫Øng" class="w-16 h-16 object-contain rounded" draggable="false" />
        </li>
      </ul>
    </div>

    <!-- Khung 2: bi·ªÉu ƒë·ªì -->
    <div id="chart-view" class="hidden">
      <canvas id="stats-chart" width="300" height="200"></canvas>
    </div>
      <script>
// L·∫•y d·ªØ li·ªáu t·ª´ localStorage
const sessionHistory = JSON.parse(localStorage.getItem("sessionHistory")) || [];

// Gom t·ªïng th·ªùi gian theo th√°ng
const monthlyData = {};
sessionHistory.forEach(s => {
  const month = s.date.slice(0, 7); // YYYY-MM
  // N·∫øu b·∫°n l∆∞u score th√¨ c·ªông score, n·∫øu l∆∞u durationMinutes th√¨ c·ªông durationMinutes
  const value = s.durationMinutes ?? s.score ?? 0;
  monthlyData[month] = (monthlyData[month] || 0) + value;
});

const labels = Object.keys(monthlyData);
const data = Object.values(monthlyData);

// T·∫°o bi·ªÉu ƒë·ªì
const ctx = document.getElementById("stats-chart").getContext("2d");
new Chart(ctx, {
  type: "bar",
  data: {
    labels: labels,
    datasets: [
      {
        label: "T·ªïng th·ªùi gian t·∫≠p trung (ph√∫t)",
        data: data,
        backgroundColor: "rgba(255, 105, 180, 0.7)", // h·ªìng pastel
        borderColor: "rgba(255, 105, 180, 1)",
        borderWidth: 1,
        borderRadius: 6
      }
    ]
  },
  options: {
    responsive: true,
    plugins: {
      legend: {
        display: false
      },
      tooltip: {
        callbacks: {
          label: (context) => context.raw + " ph√∫t"
        }
      }
    },
    scales: {
      y: {
        beginAtZero: true,
        title: {
          display: true,
          text: "Ph√∫t"
        }
      },
      x: {
        title: {
          display: true,
          text: "Th√°ng"
        }
      }
    }
  }
});
</script>

 <!-- Th√¥ng tin phi√™n -->
    <div id="session-info" class="mt-4 p-4 bg-gray-100 rounded-lg text-center text-gray-700 min-h-[4rem] select-none" aria-live="polite" aria-atomic="true"></div>

    <!-- N√∫t ƒë√≥ng -->
    <button
      id="statistics-close"
      class="mt-4 px-6 py-2 rounded bg-[#DC143C] hover:bg-[#b0102a] text-white font-semibold mx-auto focus:outline-none focus:ring-2 focus:ring-[#b0102a]"
      type="button"
    >
      ƒê√≥ng
    </button>
  </div>
</div>


               <!-- Overlay -->
  <div
    id="overlay"
    class="fixed inset-0 bg-black bg-opacity-40 hidden z-40"
  ></div>

  <!-- Info Panel Centered -->
  <aside
    id="infoPanel"
    class="fixed top-1/2 left-1/2 w-80 max-w-full bg-white shadow-lg rounded-lg p-6 transform -translate-x-1/2 -translate-y-1/2 scale-0 transition-transform duration-300 ease-in-out z-50 overflow-y-auto max-h-[80vh]"
    aria-hidden="true"
  >
    <h2 class="text-2xl font-semibold mb-4 text-green-700">Th√¥ng tin</h2>
    <p class="mb-4 text-gray-700">
      Th√¥ng tin
    </p>
    <ul class="list-disc list-inside space-y-2 text-gray-600">
      <li>1.Sau khi b·∫Øt ƒë·∫ßu t·∫≠p trung, kh√¥ng th·ªÉ thay ƒë·ªïi th·ªùi gian.</li>
      <li>2.C·∫ßn t·∫≠p trung t·ª´ 5 ph√∫t tr·ªü l√™n: nh·∫≠n ƒë∆∞·ª£c b√°nh ƒë√£ ch·ªçn.</li>
      <li>3. n·∫øu c√≥ g√≥p √Ω hay th·∫Øc m·∫Øc n√†o h√£y b·∫•m v√†o n√∫t b√™n g√≥c tr√°i </li>
    </ul>
    <button
      id="infoImageBtn"
      type="button"
      aria-label="N√∫t d·∫´n t·ªõi https://s.shopee.vn/2LOiiEexWq"
      class="mt-2 mx-auto block focus:outline-none focus:ring-2 focus:ring-[#9BBA74] rounded"
      onclick="window.location.href='https://s.shopee.vn/2LOiiEexWq'"
      style="width: 36.8rem; max-width: 100%;"
    >
      <img
        src="https://raw.githubusercontent.com/thuyvannnnnn/Focus-and-frost/4fb2c5e6beca14572e1804fba69eed7455380768/01483ACC-E2E7-46D0-B15C-35BB9D41E3C4.png"
        class="w-full h-auto object-contain"
        draggable="false"
      />
    </button>
    <button
      id="closeInfoBtn"
      class="mt-2 px-6 py-2 rounded bg-[#DC143C] hover:bg-[#b0102a] text-white font-semibold mx-auto block focus:outline-none focus:ring-2 focus:ring-[#b0102a]"
      type="button"
    >
      ƒê√≥ng
    </button>
  </aside>

  <audio id="background-music" loop preload="auto" src="https://github.com/thuyvannnnnn/Focus-and-frost/raw/refs/heads/main/45.audio.mp3"></audio>

  <!-- Script Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client"></script>

  <script>

 const btnReward = document.getElementById("btn-reward");
const btnChart = document.getElementById("btn-chart");
const rewardView = document.getElementById("reward-view");
const chartView = document.getElementById("chart-view");

function switchTab(tab) {
  if (tab === "reward") {
    rewardView.classList.remove("hidden");
    chartView.classList.add("hidden");
    btnReward.classList.add("active");
    btnChart.classList.remove("active");
  } else {
    chartView.classList.remove("hidden");
    rewardView.classList.add("hidden");
    btnChart.classList.add("active");
    btnReward.classList.remove("active");
  }
}

btnReward.addEventListener("click", () => switchTab("reward"));
btnChart.addEventListener("click", () => switchTab("chart"));



    let googleUser  = JSON.parse(localStorage.getItem("googleuser")) || null;

    const googleSignInButton = document.getElementById("googleSignInButton");
    const googleLogoutBtn = document.getElementById("googleLogoutBtn");
    const userAvatar = document.getElementById("userAvatar");

    function updateLoginButtonUI() {
      if (googleUser) {
        googleSignInButton.style.display = "none";
        googleLogoutBtn.style.display = "flex";
        userAvatar.src = googleUser.picture;
        userAvatar.alt = `·∫¢nh ƒë·∫°i di·ªán c·ªßa ${googleUser.name}`;
        userAvatar.classList.remove("hidden");
        googleLogoutBtn.title = "ƒêƒÉng xu·∫•t t√†i kho·∫£n Google";
      } else {
        googleSignInButton.style.display = "flex";
        googleLogoutBtn.style.display = "none";
        userAvatar.classList.add("hidden");
        userAvatar.src = "";
        userAvatar.alt = "";
      }
    }

    function initializeGoogleSignIn() {
      google.accounts.id.initialize({
        client_id: "854945467513-gvec4958ef17nqjsoauvk9dcqinceeel.apps.googleusercontent.com",
        callback: handleCredentialResponse,
        auto_select: false,
        cancel_on_tap_outside: false
      });
      google.accounts.id.renderButton(
        googleSignInButton,
        { theme: "filled_green", size: "medium", width: 160, height: 40 }
      );
    }

    function handleCredentialResponse(response) {
      const data = parseJwt(response.credential);
      googleUser  = {
        id: data.sub,
        name: data.name,
        email: data.email,
        picture: data.picture
      };
      localStorage.setItem("googleuser", JSON.stringify(googleUser ));
      updateLoginButtonUI();
      alert("B·∫°n ƒë√£ ƒëƒÉng nh·∫≠p th√†nh c√¥ng: " + googleUser.name);
    }

    googleLogoutBtn.addEventListener("click", () => {
      if (confirm("B·∫°n c√≥ mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?")) {
        googleUser  = null;
        localStorage.removeItem("googleuser");
        updateLoginButtonUI();
        alert("B·∫°n ƒë√£ ƒëƒÉng xu·∫•t.");
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      updateLoginButtonUI();
      initializeGoogleSignIn();
    });

    // H√†m parse JWT gi·ªØ nguy√™n
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
      } catch {
        return {};
      }
    }
  </script>

  <script>
    // Remove cakeinventory, plateinventory, decorinventory from localStorage on load
    localStorage.removeItem('cakeinventory');
    localStorage.removeItem('plateinventory');
    localStorage.removeItem('decorinventory');

    // Data
    const cakes = {
      Macaron: {
        name: "Macaron",
        img: "https://raw.githubusercontent.com/thuyvannnnnn/Focus-and-frost/main/00CC2FB6-9ED5-4466-9DDB-C7B89C391BB1.png",
        alt: "H√¨nh ·∫£nh Macaron m√†u h·ªìng pastel, b√°nh ng·ªçt tr√≤n nh·ªè xinh x·∫Øn, n·ªÅn tr·∫Øng",
      },
      "b√°nh m√¢m x√¥i": {
        name: "b√°nh m√¢m x√¥i",
        img: "https://raw.githubusercontent.com/thuyvannnnnn/Focus-and-frost/main/IMG_7293.png",
        alt: "H√¨nh ·∫£nh qu·∫£ c√† t√≠m t√≠m t∆∞∆°i, b√≥ng m∆∞·ª£t, n·ªÅn tr·∫Øng",
      },
      "b√°nh cherry": {
        name: "b√°nh cherry",
        img: "https://raw.githubusercontent.com/thuyvannnnnn/Focus-and-frost/main/B89384A0-0587-48F6-BBCB-4EC98C592F1C.png",
        alt: "H√¨nh ·∫£nh b√°nh cherry m√†u ƒë·ªè t∆∞∆°i, b√°nh tr√≤n nh·ªè, n·ªÅn tr·∫Øng",
      },
      "b√°nh n∆∞·ªõng b√≥ng ƒë√™m": {
        name: "b√°nh n∆∞·ªõng b√≥ng ƒë√™m",
        img: "https://raw.githubusercontent.com/thuyvannnnnn/Focus-and-frost/main/037F53D1-AC5D-4165-BD08-FEFF3F39FD7D.png",
        alt: "H√¨nh ·∫£nh b√°nh b·ªã ch√°y ƒëen, b√°nh tr√≤n, n·ªÅn tr·∫Øng",
      }
    };

    // State
    let selectedCake = "Macaron";
    let selectedTime = { h: 0, m: 0, s: 0 };
    let timerInterval = null;
    let isRunning = false;
    let remainingSeconds = 0;
    let elapsedSeconds = 0; // time already counted before pause
    let rewardInventory = JSON.parse(localStorage.getItem("rewardInventory")) || [];
    let sessionHistory = JSON.parse(localStorage.getItem("sessionHistory")) || [];

    // Elements
    const cakeImageEl = document.getElementById("cake-image");
    const circleCakeBtn = document.getElementById("circle-cake");
    const selectedCakeNameEl = document.getElementById("selected-cake-name");
  const btnStartStop = document.getElementById("btn-start-stop");
    const inputHour = document.getElementById("input-hour");
    const inputMinute = document.getElementById("input-minute");
    const inputSecond = document.getElementById("input-second");
    const menuSelectCake = document.getElementById("menu-select-cake");
    const menuCakeList = document.getElementById("menu-cake-list");
    const cookingGif = document.getElementById("cooking-gif");
    const rewardModal = document.getElementById("reward-modal");
    const rewardContent = document.getElementById("reward-content");
    const rewardConfirmBtn = document.getElementById("reward-confirm");
    const rewardCloseBtn = document.getElementById("reward-close");
    const feedbackBtn = document.getElementById("btn-feedback");
    const feedbackForm = document.getElementById("feedback-form");
    const feedbackMessage = document.getElementById("feedback-message");
    const backgroundMusic = document.getElementById("background-music");
    const timeProgressBar = document.getElementById("time-progress-bar");

    // Statistics modal elements
    const statisticsModal = document.getElementById("statistics-modal");
    const statisticsCloseBtn = document.getElementById("statistics-close");
    const cakeListEl = document.getElementById("cake-list");
    const sessionInfoEl = document.getElementById("session-info");
    const btnStatistics = document.getElementById("btn-statistics");

    // Info panel elements
    const infoToggleBtn = document.getElementById("infoToggleBtn");
    const infoPanel = document.getElementById("infoPanel");
    const closeInfoBtn = document.getElementById("closeInfoBtn");
    const overlay = document.getElementById("overlay");

    // Functions for info panel
    function openPanel() {
      infoPanel.classList.remove("scale-0");
      infoPanel.setAttribute("aria-hidden", "false");
      overlay.classList.remove("hidden");
    }

    function closePanel() {
      infoPanel.classList.add("scale-0");
      infoPanel.setAttribute("aria-hidden", "true");
      overlay.classList.add("hidden");
    }

    infoToggleBtn.addEventListener("click", () => {
      if (infoPanel.classList.contains("scale-0")) {
        openPanel();
      } else {
        closePanel();
      }
    });

    closeInfoBtn.addEventListener("click", closePanel);

    overlay.addEventListener("click", closePanel);

    function updateCakeDisplay() {
      const cake = cakes[selectedCake];
      cakeImageEl.src = cake.img;
      cakeImageEl.alt = cake.alt;
      selectedCakeNameEl.textContent = cake.name;
    }

  
    function updateStartButtonState() {
      const h = Math.min(Math.max(parseInt(inputHour.value) || 0, 0), 23);
      const m = Math.min(Math.max(parseInt(inputMinute.value) || 0, 0), 59);
      const s = Math.min(Math.max(parseInt(inputSecond.value) || 0, 0), 59);
      const hasTime = h + m + s > 0 || elapsedSeconds > 0;
      const hasCake = !!selectedCake;
      btnStartStop.disabled = !(hasTime && hasCake);
      btnStartStop.classList.toggle("bg-[#9BBA74]", !isRunning && !btnStartStop.disabled);
      btnStartStop.classList.toggle("hover:bg-[#8aa85a]", !isRunning && !btnStartStop.disabled);
      btnStartStop.classList.toggle("bg-[#DC143C]", isRunning);
      btnStartStop.classList.toggle("hover:bg-[#b0102a]", isRunning);
      if (isRunning) {
        btnStartStop.textContent = "D·ª´ng l·∫°i";
        btnStartStop.style.color = "white";
      } else {
        btnStartStop.style.color = "white";
        btnStartStop.textContent = elapsedSeconds > 0 ? "D√πng l·∫°i" : "B·∫Øt ƒë·∫ßu";
      }
    }

       function parseTimeInputs() {
      return {
        h: Math.min(Math.max(parseInt(inputHour.value) || 0, 0), 23),
        m: Math.min(Math.max(parseInt(inputMinute.value) || 0, 0), 59),
        s: Math.min(Math.max(parseInt(inputSecond.value) || 0, 0), 59),
      };
    }

   function totalSeconds(time) {
      return time.h * 3600 + time.m * 60 + time.s;
    }

    function formatTime(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      return (
        (h > 0 ? String(h).padStart(2, "0") + ":" : "") +
        String(m).padStart(2, "0") +
        ":" +
        String(s).padStart(2, "0")
      );
    }


    function updateTimeInputsFromRemaining() {
      const h = Math.floor(remainingSeconds / 3600);
      const m = Math.floor((remainingSeconds % 3600) / 60);
      const s = remainingSeconds % 60;
      inputHour.value = h > 0 ? h : "";
      inputMinute.value = m > 0 || h > 0 ? m : "";
      inputSecond.value = s > 0 || m > 0 || h > 0 ? s : "";
    }

    function updateProgressBar() {
      if (selectedTimeTotalSeconds === 0) {
        timeProgressBar.style.width = "0%";
        return;
      }
      const percent = (remainingSeconds / selectedTimeTotalSeconds) * 100;
      timeProgressBar.style.width = percent + "%";
    }

    let selectedTimeTotalSeconds = 0;
   function startTimer() {
      if (isRunning) return;
      if (elapsedSeconds === 0) {
        selectedTime = parseTimeInputs();
        selectedTimeTotalSeconds = totalSeconds(selectedTime);
        remainingSeconds = selectedTimeTotalSeconds;
      } else { 
        remainingSeconds = selectedTimeTotalSeconds - elapsedSeconds;
      }
      if (remainingSeconds <= 0) return;
      isRunning = true;
      updateStartButtonState();
      cookingGif.classList.remove("hidden");
      cakeImageEl.classList.add("hidden");
      backgroundMusic.play().catch(() => {});
      updateTimeInputsFromRemaining();
      updateProgressBar();
      timerInterval = setInterval(() => {
        remainingSeconds--;
        elapsedSeconds++;
        updateTimeInputsFromRemaining();
        updateProgressBar();
        if (remainingSeconds <= 0) {
          stopTimer(true);
        }
      }, 1000);
      disableInputs(true);
    }

    function stopTimer(finished = false) {
      if (!isRunning) return;
      isRunning = false; // ƒê·∫∑t l·∫°i tr·∫°ng th√°i ch·∫°y
      clearInterval(timerInterval);
      timerInterval = null;
      cookingGif.classList.add("hidden");
      cakeImageEl.classList.remove("hidden");
      backgroundMusic.pause();
      backgroundMusic.currentTime = 0;
      disableInputs(false);
      if (finished) {
        saveSessionHistory(elapsedSeconds);
        addSessionToList(elapsedSeconds);
        showReward(elapsedSeconds);
        renderRewardInventory();
        resetTimerState(); // reset v√† update n√∫t ·ªü ƒë√¢y
      } else {
        updateStartButtonState(); // n·∫øu d·ª´ng gi·ªØa ch·ª´ng th√¨ update n√∫t
      }
    }

    

    function resetTimerState() {
      elapsedSeconds = 0;
      selectedTimeTotalSeconds = 0;
      inputHour.value = "";
      inputMinute.value = "";
      inputSecond.value = "";
      timeProgressBar.style.width = "100%";
      updateStartButtonState();
    }

    function disableInputs(disable) {
      inputHour.disabled = disable;
      inputMinute.disabled = disable;
      inputSecond.disabled = disable;
      circleCakeBtn.disabled = disable;
      document.getElementById("btn-statistics").disabled = disable;
    } 
    function showReward(elapsed) {
      const timeMinutes = elapsed / 60;
      let rewards = [];
      let rewardName = "";
      if (timeMinutes < 3) {
        // Under 3 minutes: reward "b√°nh n∆∞·ªõng b√≥ng ƒë√™m" cake
        rewards = [{
          type: "cake",
          name: "b√°nh n∆∞·ªõng b√≥ng ƒë√™m",
          img: cakes["b√°nh n∆∞·ªõng b√≥ng ƒë√™m"].img,
          alt: cakes["b√°nh n∆∞·ªõng b√≥ng ƒë√™m"].alt,
        }];
        rewardName = "b√°nh n∆∞·ªõng b√≥ng ƒë√™m";
      } else {
        // 5 minutes or more: receive selected cake only
        rewards = [{
          type: "cake",
          name: selectedCake,
          img: cakes[selectedCake].img,
          alt: cakes[selectedCake].alt,
        }];
        rewardName = selectedCake;
      }

      let rewardInventoryLocal = JSON.parse(localStorage.getItem("rewardInventory")) || [];
      const now = new Date();
      const dateStr = now.toISOString().slice(0, 10);
      const timeStr = now.toTimeString().slice(0, 5);

      rewards.forEach(r => {
        // Save reward with time and date
        const rewardWithDate = {
          ...r,
          date: dateStr,
          time: timeStr,
          durationMinutes: Math.floor(elapsed / 60),
          id: Date.now() + Math.random(), // unique id
        };
        rewardInventoryLocal.push(rewardWithDate);
      });
      localStorage.setItem("rewardInventory", JSON.stringify(rewardInventoryLocal));
      rewardInventory = rewardInventoryLocal;

      rewardContent.innerHTML = "";
      rewards.forEach((r) => {
        const div = document.createElement("div");
        div.className = "flex flex-col items-center space-y-1";
        const img = document.createElement("img");
        img.src = r.img;
        img.alt = r.alt;
        img.className = "w-[56px] h-[56px] object-contain";
        img.draggable = false;
        const span = document.createElement("span");
        span.className = "text-gray-800 font-semibold text-center text-sm";
        span.textContent = r.name;
        div.appendChild(img);
        div.appendChild(span);
        rewardContent.appendChild(div);
      });
      const textLine = document.createElement("p");
      textLine.className = "text-center font-semibold text-lg text-gray-900 mt-2";
      textLine.textContent =
        "Hoan h√¥! B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c " +
        rewards.map((r) => r.name).join(", ") +
        ".";
      rewardContent.appendChild(textLine);

      rewardModal.classList.remove("hidden");
    }


    function saveSessionHistory(elapsedSeconds) {
      if (elapsedSeconds <= 0) return;
      const now = new Date();
      const dateStr = now.toISOString().slice(0, 10);
      const timeStr = now.toTimeString().slice(0, 5);
      const newSession = {
        id: Date.now(),
        name: selectedCake,
        time: timeStr,
        date: dateStr,
        timeSeconds: elapsedSeconds,
        durationMinutes: Math.floor(elapsedSeconds / 60),
        image: cakes[selectedCake].img,
      };
      sessionHistory.push(newSession);
      localStorage.setItem("sessionHistory", JSON.stringify(sessionHistory));
    }

    function addSessionToList(elapsedSeconds) {
      const now = new Date();
      const dateStr = now.toISOString().slice(0, 10);
      const timeStr = now.toTimeString().slice(0, 5);
      const session = {
        id: Date.now(),
        name: selectedCake,
        time: timeStr,
        date: dateStr,
        timeSeconds: elapsedSeconds,
        durationMinutes: Math.floor(elapsedSeconds / 60),
        image: cakes[selectedCake].img,
      };
      sessionHistory.push(session);
      localStorage.setItem("sessionHistory", JSON.stringify(sessionHistory));
      renderSessionList();
    }

    function renderSessionList() {
      cakeListEl.innerHTML = "";
      if (!sessionHistory.length && rewardInventory.length === 0) {
        const emptyMsg = document.createElement("p");
        emptyMsg.className = "text-center text-gray-500 w-full";
        emptyMsg.textContent = "Ch∆∞a c√≥ l·ªãch s·ª≠ t·∫≠p trung ho·∫∑c ph·∫ßn th∆∞·ªüng n√†o.";
        cakeListEl.appendChild(emptyMsg);
        sessionInfoEl.textContent = "";
        return;
      }
      // Show all rewardInventory items (with images, duplicates allowed)
      rewardInventory.forEach(item => {
        if (item.name === "Kem 1" || item.name === "Xanh l√°") return;

        const li = document.createElement("li");
        li.className = "cursor-pointer rounded";
        li.setAttribute("tabindex", "0");
        li.setAttribute("role", "button");
        li.setAttribute("aria-label", `${item.name}, ng√†y: ${item.date}, th·ªùi gian nh·∫≠n: ${item.time}, th·ªùi l∆∞·ª£ng: ${item.durationMinutes} ph√∫t`);
        li.dataset.name = item.name;
        li.dataset.date = item.date;
        li.dataset.time = item.time;
        li.dataset.durationMinutes = item.durationMinutes;

        const img = document.createElement("img");
        img.src = item.img;
        img.alt = item.alt;
        img.className = "w-16 h-16 object-contain rounded";
        img.draggable = false;

        li.appendChild(img);
        cakeListEl.appendChild(li);

        li.addEventListener("click", () => {
          showSessionInfoByNameDateTime(item.name, item.date, item.time, item.durationMinutes);
        });
        li.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            showSessionInfoByNameDateTime(item.name, item.date, item.time, item.durationMinutes);
          }
        });
      });
      sessionInfoEl.textContent = "";
    }

    function showSessionInfoByNameDateTime(name, date, time, duration) {
      sessionInfoEl.textContent = ` ${name} | Ng√†y: ${date} | ${time} | Th·ªùi l∆∞·ª£ng: ${duration} ph√∫t` ;
    }

      function renderCakeMenu() {
      const menuCakeList = document.getElementById("menu-cake-list");
      menuCakeList.innerHTML = "";
      Object.keys(cakes).forEach(cakeName => {
        if (cakeName.trim() === "b√°nh n∆∞·ªõng b√≥ng ƒë√™m") return; // B·ªè b√°nh n∆∞·ªõng b√≥ng ƒë√™m kh·ªèi menu n·∫øu mu·ªën
        const cake = cakes[cakeName];

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "flex flex-col items-center space-y-1 focus:outline-none focus:ring-2 focus:ring-[#9BBA74] rounded";
        btn.setAttribute("data-cake", cakeName);
        btn.setAttribute("aria-label", `Ch·ªçn m√≥n ${cakeName}`);

        const img = document.createElement("img");
        img.src = cake.img;
        img.alt = cake.alt;
        img.className = "w-14 h-14 object-contain";
        img.draggable = false;

        const span = document.createElement("span");
        span.className = "text-sm font-semibold text-gray-700";
        span.textContent = cakeName;

        btn.appendChild(img);
        btn.appendChild(span);

        btn.addEventListener("click", () => {
          if (isRunning) return;
          selectedCake = cakeName;
          updateCakeDisplay();
          menuSelectCake.classList.add("hidden");
          updateStartButtonState();
        });

        menuCakeList.appendChild(btn);
      });
    }

    inputHour.addEventListener("input", () => {
      if (inputHour.value.length > 2) inputHour.value = inputHour.value.slice(0, 2);
      updateStartButtonState();
    });
    inputMinute.addEventListener("input", () => {
      if (inputMinute.value.length > 2) inputMinute.value = inputMinute.value.slice(0, 2);
      updateStartButtonState();
    });
    inputSecond.addEventListener("input", () => {
      if (inputSecond.value.length > 2) inputSecond.value = inputSecond.value.slice(0, 2);
      updateStartButtonState();
    });

    btnStartStop.addEventListener("click", () => {
      if (isRunning) {
        stopTimer(false);
      } else {
        startTimer();
      }
    });

    circleCakeBtn.addEventListener("click", () => {
      if (isRunning) return;
      menuSelectCake.classList.toggle("hidden");
    });



    rewardConfirmBtn.addEventListener("click", () => {
      rewardModal.classList.add("hidden");
    });

    rewardCloseBtn.addEventListener("click", () => {
      rewardModal.classList.add("hidden");
    });

    feedbackBtn.addEventListener("click", () => {
      const message = prompt("Vui l√≤ng nh·∫≠p g√≥p √Ω c·ªßa b·∫°n:");
      if (message === null) return;
      if (message.trim() === "") {
        alert("Vui l√≤ng nh·∫≠p n·ªôi dung g√≥p √Ω.");
        return;
      }
      feedbackMessage.value = message.trim();
      feedbackForm.submit();
    });

    btnStatistics.addEventListener('click', () => {
      if (isRunning) return;
      renderSessionList();
      statisticsModal.classList.remove("hidden");
    });

    statisticsCloseBtn.addEventListener('click', () => {
      statisticsModal.classList.add("hidden");
    });

      
    if (!localStorage.getItem('sessionHistory')) {
      localStorage.setItem('sessionHistory', JSON.stringify([]));
    }

    window.addEventListener("load", () => {
      updateCakeDisplay();
      updateStartButtonState();
      renderCakeMenu();
      updateLoginButtonUI();
      renderRewardInventory();
      timeProgressBar.style.width = "100%";
      initializeGoogleSignIn();
    });

    function renderRewardInventory() {
      renderSessionList();
    } 

    // JWT parse helper
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
      } catch {
        return {};
      }
    }

  </script>
</body>
</html>
